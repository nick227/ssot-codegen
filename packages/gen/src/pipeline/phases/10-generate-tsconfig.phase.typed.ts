/**
 * Phase 10: Generate TypeScript Config (Strongly-Typed)
 * 
 * Generates TypeScript path mappings.
 * 
 * MIGRATION STATUS: âœ… Migrated to typed context
 */

import path from 'node:path'
import { TypedPhaseAdapter } from '../typed-phase-adapter.js'
import { writeFile } from '../phase-utilities.js'
import type { 
  ContextAfterPhase9, 
  GenerateTsConfigOutput 
} from '../typed-context.js'

export class GenerateTsConfigPhaseTyped extends TypedPhaseAdapter<
  ContextAfterPhase9,         // Requires: Phase 0-9 outputs + metrics
  GenerateTsConfigOutput      // Provides: (tsconfig paths written)
> {
  readonly name = 'generateTsConfig'
  readonly order = 10
  
  getDescription(): string {
    return 'Generating TypeScript config'
  }
  
  /**
   * Strongly-typed execution
   * 
   * TypeScript guarantees:
   * - context.pathsConfig exists (from Phase 4)
   * 
   * NO RUNTIME CHECKS NEEDED!
   */
  async executeTyped(context: ContextAfterPhase9): Promise<GenerateTsConfigOutput> {
    const { pathsConfig: cfg } = context
    
    const tsconfigPathsContent = {
      compilerOptions: {
        baseUrl: '.',
        paths: {
          [`${cfg.alias}/*`]: [`${cfg.rootDir}/*`]
        }
      }
    }
    
    const tsconfigPath = path.join(path.resolve('.'), 'tsconfig.paths.json')
    await writeFile(tsconfigPath, JSON.stringify(tsconfigPathsContent, null, 2))
    
    // Return empty object (phase doesn't add data to context)
    return {}
  }
  
  /**
   * Count files generated by this phase
   */
  protected override countFiles(): number {
    return 1 // tsconfig.paths.json
  }
}

