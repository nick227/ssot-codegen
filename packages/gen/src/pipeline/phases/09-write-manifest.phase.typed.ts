/**
 * Phase 9: Write Manifest (Strongly-Typed)
 * 
 * Writes generation manifest with metadata.
 * 
 * MIGRATION STATUS: âœ… Migrated to typed context
 */

import path from 'node:path'
import crypto from 'node:crypto'
import { TypedPhaseAdapter } from '../typed-phase-adapter.js'
import { writeFile, getTrackedPaths } from '../phase-utilities.js'
import { getGeneratorVersion } from '@/utils/version.js'
import type { 
  ContextAfterPhase8, 
  WriteManifestOutput 
} from '../typed-context.js'

const hash = (text: string) => crypto.createHash('sha256').update(text).digest('hex')

export class WriteManifestPhaseTyped extends TypedPhaseAdapter<
  ContextAfterPhase8,       // Requires: Phase 0-8 outputs
  WriteManifestOutput       // Provides: (manifest written)
> {
  readonly name = 'writeManifest'
  readonly order = 9
  
  getDescription(): string {
    return 'Writing manifest'
  }
  
  /**
   * Strongly-typed execution
   * 
   * TypeScript guarantees:
   * - context.schemaContent exists (from Phase 1)
   * - context.pathsConfig exists (from Phase 4)
   * - context.modelNames exists (from Phase 1)
   * - context.config exists (from BaseContext)
   * - context.totalFiles exists (from Phase 4)
   * - context.breakdown exists (from Phase 4)
   * 
   * NO RUNTIME CHECKS NEEDED!
   */
  async executeTyped(context: ContextAfterPhase8): Promise<WriteManifestOutput> {
    const { 
      schemaContent, 
      pathsConfig: cfg, 
      modelNames, 
      config, 
      totalFiles, 
      breakdown 
    } = context
    
    const schemaHash = hash(config.schemaText || schemaContent)
    const version = await getGeneratorVersion()
    const pathMap = getTrackedPaths()
    
    // Build outputs array from pathMap
    const outputs = Object.entries(pathMap).map(([id, paths]) => ({
      id,
      fsPath: paths.fs,
      esmPath: paths.esm
    }))
    
    // Note: phaseMetrics will be added by PhaseRunner after this phase completes
    const manifest = {
      schemaHash,
      models: modelNames,
      version,
      generatedAt: new Date().toISOString(),
      totalFiles,
      breakdown,
      pathMap,
      outputs
    }
    
    const manifestPath = path.join(cfg.rootDir, 'manifests', 'generation.json')
    await writeFile(manifestPath, JSON.stringify(manifest, null, 2))
    
    // Return empty object (phase doesn't add data to context)
    return {}
  }
  
  /**
   * Count files generated by this phase
   */
  protected override countFiles(): number {
    return 1 // generation.json
  }
}

