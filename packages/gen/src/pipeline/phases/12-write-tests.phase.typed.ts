/**
 * Phase 12: Write Tests (Strongly-Typed)
 * 
 * Writes self-validation test suite.
 * Only runs in standalone mode.
 * 
 * MIGRATION STATUS: âœ… Migrated to typed context
 */

import path from 'node:path'
import { TypedPhaseAdapter } from '../typed-phase-adapter.js'
import { 
  generateSelfValidationTests, 
  generateVitestConfig, 
  generateTestSetup 
} from '@/generators/test-generator.js'
import { writeFile } from '../phase-utilities.js'
import type { 
  ContextAfterPhase11, 
  GenerateTestSuiteOutput 
} from '../typed-context.js'

export class WriteTestsPhaseTyped extends TypedPhaseAdapter<
  ContextAfterPhase11,         // Requires: Phase 0-11 outputs
  GenerateTestSuiteOutput      // Provides: (test suite written)
> {
  readonly name = 'writeTests'
  readonly order = 12
  
  shouldRunTyped(context: ContextAfterPhase11): boolean {
    return context.config.standalone ?? true
  }
  
  getDescription(): string {
    return 'Generating self-validation tests'
  }
  
  /**
   * Strongly-typed execution
   * 
   * TypeScript guarantees:
   * - context.schema exists (from Phase 1)
   * - context.outputDir exists (from Phase 0)
   * - context.config exists (from BaseContext)
   * 
   * NO RUNTIME CHECKS NEEDED!
   */
  async executeTyped(context: ContextAfterPhase11): Promise<GenerateTestSuiteOutput> {
    const { schema, outputDir, config } = context
    
    const framework = config.framework || 'express'
    const writes: Promise<void>[] = []
    
    // Generate self-validation test
    const testContent = generateSelfValidationTests({ models: schema.models, framework })
    const testPath = path.join(outputDir, 'tests', 'self-validation.test.ts')
    writes.push(writeFile(testPath, testContent))
    
    // Generate vitest config
    const vitestConfigContent = generateVitestConfig()
    const vitestConfigPath = path.join(outputDir, 'vitest.config.ts')
    writes.push(writeFile(vitestConfigPath, vitestConfigContent))
    
    // Generate test setup
    const setupContent = generateTestSetup()
    const setupPath = path.join(outputDir, 'tests', 'setup.ts')
    writes.push(writeFile(setupPath, setupContent))
    
    await Promise.all(writes)
    
    // Return empty object (phase doesn't add data to context)
    return {}
  }
  
  /**
   * Count files generated by this phase
   */
  protected override countFiles(): number {
    return 3 // self-validation.test.ts, vitest.config.ts, setup.ts
  }
}

