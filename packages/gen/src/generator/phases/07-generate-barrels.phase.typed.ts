/**
 * Phase 7: Generate Barrels (Strongly-Typed)
 * 
 * Generates barrel export files for all layers.
 * 
 * MIGRATION STATUS: âœ… Migrated to typed context
 */

import { TypedPhaseAdapter } from '../typed-phase-adapter.js'
import { writeFile, trackPath, generateEsmPath } from '../phase-utilities.js'
import { determineBarrelWrites } from '../../utils/barrel-orchestrator.js'
import type { 
  ContextAfterPhase6, 
  GenerateBarrelsOutput 
} from '../typed-context.js'

export class GenerateBarrelsPhaseTyped extends TypedPhaseAdapter<
  ContextAfterPhase6,        // Requires: Phase 0-6 outputs
  GenerateBarrelsOutput      // Provides: (barrel files generated)
> {
  readonly name = 'generateBarrels'
  readonly order = 7
  
  getDescription(): string {
    return 'Generating barrel exports'
  }
  
  /**
   * Strongly-typed execution
   * 
   * TypeScript guarantees:
   * - context.pathsConfig exists (from Phase 4)
   * - context.generatedFiles exists (from Phase 4)
   * - context.modelNames exists (from Phase 1)
   * 
   * NO RUNTIME CHECKS NEEDED!
   */
  async executeTyped(context: ContextAfterPhase6): Promise<GenerateBarrelsOutput> {
    const { generatedFiles, pathsConfig: cfg, modelNames } = context
    
    // Determine all barrel writes using centralized orchestrator
    const barrelWrites = determineBarrelWrites(
      cfg,
      modelNames,
      generatedFiles,
      (layer, model) => generateEsmPath(cfg, layer, model)
    )
    
    // Execute all writes in parallel and track paths
    const writes = barrelWrites.map(barrel => {
      trackPath(barrel.trackId, barrel.path, barrel.esmPath)
      return writeFile(barrel.path, barrel.content)
    })
    
    await Promise.all(writes)
    
    // Return empty object (phase doesn't add data to context)
    return {}
  }
  
  /**
   * Count files generated by this phase
   */
  protected override countFiles(): number {
    // Dynamic count based on models and layers
    // Will be calculated during execution
    return 0
  }
}

