/**
 * Phase 6: Write Infrastructure
 * 
 * Writes base infrastructure files (BaseCRUDController, etc.)
 */

import fs from 'node:fs'
import path from 'node:path'
import { GenerationPhase, type PhaseContext, type PhaseResult } from '../phase-runner.js'
import { esmImport } from '../../path-resolver.js'

const ensureDir = async (p: string) => fs.promises.mkdir(p, { recursive: true })
const write = async (file: string, content: string) => { 
  await ensureDir(path.dirname(file))
  await fs.promises.writeFile(file, content, 'utf8')
}

const pathMap: Record<string, { fs: string; esm: string }> = {}
const track = (idStr: string, fsPath: string, esmPath: string) => {
  pathMap[idStr] = { fs: fsPath, esm: esmPath }
}

const id = (layer: string, model?: string, file?: string) => ({ layer, model, file })

export class WriteInfrastructurePhase extends GenerationPhase {
  readonly name = 'writeInfrastructure'
  readonly order = 6
  
  getDescription(): string {
    return 'Writing base infrastructure'
  }
  
  async execute(context: PhaseContext): Promise<PhaseResult> {
    const cfg = (context as any).pathsConfig
    
    if (!cfg) {
      throw new Error('Paths config not found in context')
    }
    
    const { baseCRUDControllerTemplate } = await import('../../templates/base-crud-controller.template.js')
    const { baseServiceControllerTemplate } = await import('../../templates/base-service-controller.template.js')
    
    const baseDir = path.join(cfg.rootDir, 'base')
    const baseCRUDPath = path.join(baseDir, 'base-crud-controller.ts')
    const baseServicePath = path.join(baseDir, 'base-service-controller.ts')
    const indexPath = path.join(baseDir, 'index.ts')
    
    const writes: Promise<void>[] = []
    
    // Write base CRUD controller
    writes.push(write(baseCRUDPath, baseCRUDControllerTemplate))
    track('base:base-crud-controller.ts', baseCRUDPath, esmImport(cfg, id('base', undefined, 'base-crud-controller.ts')))
    
    // Write base service controller
    writes.push(write(baseServicePath, baseServiceControllerTemplate))
    track('base:base-service-controller.ts', baseServicePath, esmImport(cfg, id('base', undefined, 'base-service-controller.ts')))
    
    // Write barrel export
    const indexContent = `// @generated
// This file is automatically generated. Do not edit manually.

export * from './base-crud-controller.js'
export * from './base-service-controller.js'
`
    writes.push(write(indexPath, indexContent))
    track('base:index.ts', indexPath, esmImport(cfg, id('base')))
    
    await Promise.all(writes)
    
    return {
      success: true,
      filesGenerated: 2
    }
  }
}

