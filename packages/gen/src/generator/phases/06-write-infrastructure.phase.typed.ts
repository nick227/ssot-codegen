/**
 * Phase 6: Write Infrastructure (Strongly-Typed)
 * 
 * Writes base infrastructure files (BaseCRUDController, etc.).
 * 
 * MIGRATION STATUS: âœ… Migrated to typed context
 */

import path from 'node:path'
import { TypedPhaseAdapter } from '../typed-phase-adapter.js'
import { writeFile, trackPath, generateEsmPath } from '../phase-utilities.js'
import type { 
  ContextAfterPhase5, 
  WriteBaseInfrastructureOutput 
} from '../typed-context.js'

export class WriteInfrastructurePhaseTyped extends TypedPhaseAdapter<
  ContextAfterPhase5,              // Requires: Phase 0-5 outputs
  WriteBaseInfrastructureOutput    // Provides: (infrastructure written)
> {
  readonly name = 'writeInfrastructure'
  readonly order = 6
  
  getDescription(): string {
    return 'Writing base infrastructure'
  }
  
  /**
   * Strongly-typed execution
   * 
   * TypeScript guarantees:
   * - context.pathsConfig exists (from Phase 4)
   * 
   * NO RUNTIME CHECKS NEEDED!
   */
  async executeTyped(context: ContextAfterPhase5): Promise<WriteBaseInfrastructureOutput> {
    const { pathsConfig: cfg } = context
    
    const { baseCRUDControllerTemplate } = await import('../../templates/base-crud-controller.template.js')
    const { baseServiceControllerTemplate } = await import('../../templates/base-service-controller.template.js')
    
    const baseDir = path.join(cfg.rootDir, 'base')
    const baseCRUDPath = path.join(baseDir, 'base-crud-controller.ts')
    const baseServicePath = path.join(baseDir, 'base-service-controller.ts')
    const indexPath = path.join(baseDir, 'index.ts')
    
    const writes: Promise<void>[] = []
    
    // Write base CRUD controller
    writes.push(writeFile(baseCRUDPath, baseCRUDControllerTemplate))
    trackPath('base:base-crud-controller.ts', baseCRUDPath, generateEsmPath(cfg, 'base', undefined, 'base-crud-controller.ts'))
    
    // Write base service controller
    writes.push(writeFile(baseServicePath, baseServiceControllerTemplate))
    trackPath('base:base-service-controller.ts', baseServicePath, generateEsmPath(cfg, 'base', undefined, 'base-service-controller.ts'))
    
    // Write barrel export
    const indexContent = `// @generated
// This file is automatically generated. Do not edit manually.

export * from './base-crud-controller.js'
export * from './base-service-controller.js'
`
    writes.push(writeFile(indexPath, indexContent))
    trackPath('base:index.ts', indexPath, generateEsmPath(cfg, 'base'))
    
    await Promise.all(writes)
    
    // Return empty object (phase doesn't add data to context)
    return {}
  }
  
  /**
   * Count files generated by this phase
   */
  protected override countFiles(): number {
    return 3 // base-crud-controller, base-service-controller, index
  }
}

