/**
 * Phase 8: Generate OpenAPI (Strongly-Typed)
 * 
 * Generates OpenAPI specification for the API.
 * 
 * MIGRATION STATUS: âœ… Migrated to typed context
 */

import path from 'node:path'
import { TypedPhaseAdapter } from '../typed-phase-adapter.js'
import { writeFile } from '../phase-utilities.js'
import type { 
  ContextAfterPhase7, 
  GenerateOpenAPIOutput 
} from '../typed-context.js'

export class GenerateOpenAPIPhaseTyped extends TypedPhaseAdapter<
  ContextAfterPhase7,        // Requires: Phase 0-7 outputs
  GenerateOpenAPIOutput      // Provides: (OpenAPI spec written)
> {
  readonly name = 'generateOpenAPI'
  readonly order = 8
  
  getDescription(): string {
    return 'Generating OpenAPI specification'
  }
  
  /**
   * Strongly-typed execution
   * 
   * TypeScript guarantees:
   * - context.schema exists (from Phase 1)
   * - context.pathsConfig exists (from Phase 4)
   * 
   * NO RUNTIME CHECKS NEEDED!
   */
  async executeTyped(context: ContextAfterPhase7): Promise<GenerateOpenAPIOutput> {
    const { schema, pathsConfig: cfg } = context
    
    const spec = {
      openapi: '3.1.0',
      info: {
        title: 'Generated API',
        version: '1.0.0',
        description: 'Auto-generated from Prisma schema'
      },
      servers: [
        { url: 'http://localhost:3000/api', description: 'Development' }
      ],
      paths: Object.fromEntries(
        schema.models.map((m: any) => [
          `/${m.name.toLowerCase()}s`,
          {
            get: {
              operationId: `list${m.name}s`,
              summary: `List all ${m.name} records`,
              responses: { '200': { description: 'Success' } }
            },
            post: {
              operationId: `create${m.name}`,
              summary: `Create a ${m.name}`,
              responses: { '201': { description: 'Created' } }
            }
          }
        ])
      )
    }
    
    const specPath = path.join(cfg.rootDir, 'openapi.json')
    await writeFile(specPath, JSON.stringify(spec, null, 2))
    
    // Return empty object (phase doesn't add data to context)
    return {}
  }
  
  /**
   * Count files generated by this phase
   */
  protected override countFiles(): number {
    return 1 // openapi.json
  }
}

