/**
 * Page Composer
 * 
 * Generates complete pages from declarative JSON specifications
 * Composes layout components, UI components, and data components
 */

import type { ParsedSchema } from '../../dmmf-parser.js'

export interface ComponentSpec {
  type: string
  props?: Record<string, unknown>
  children?: ComponentSpec[] | string
}

export interface PageSpec {
  layout: 'dashboard' | 'landing' | 'auth' | 'custom'
  title?: string
  sections: SectionSpec[]
  metadata?: PageMetadata
}

export interface SectionSpec {
  type: 'header' | 'footer' | 'sidebar' | 'hero' | 'content' | 'custom'
  component?: string
  props?: Record<string, unknown>
  children?: ComponentSpec[]
}

export interface PageMetadata {
  title?: string
  description?: string
  requiresAuth?: boolean
  roles?: string[]
}

export interface PageComposerConfig {
  outputDir: string
  pages: Map<string, PageSpec>
  schema: ParsedSchema
}

/**
 * Generate complete pages from specifications
 */
export function generatePages(config: PageComposerConfig): Map<string, string> {
  const files = new Map<string, string>()
  
  for (const [pagePath, pageSpec] of config.pages) {
    const pageCode = generatePageComponent(pagePath, pageSpec, config.schema)
    files.set(`${config.outputDir}/${pagePath}/page.tsx`, pageCode)
  }
  
  return files
}

/**
 * Generate a single page component from spec
 */
function generatePageComponent(
  pagePath: string,
  spec: PageSpec,
  schema: ParsedSchema
): string {
  const imports = generateImports(spec)
  const layoutWrapper = generateLayoutWrapper(spec.layout)
  const sections = spec.sections.map(s => generateSection(s, schema)).join('\n')
  
  return `/**
 * Generated Page: ${pagePath}
 * Layout: ${spec.layout}
 * Generated by SSOT Page Composer
 */

'use client'

${imports}

export default function Page() {
  return (
    ${layoutWrapper.open}
      ${sections}
    ${layoutWrapper.close}
  )
}
`
}

/**
 * Generate imports based on components used
 */
function generateImports(spec: PageSpec): string {
  const components = new Set<string>()
  
  // Collect all component types
  const collectComponents = (section: SectionSpec) => {
    if (section.component) {
      components.add(section.component)
    }
    section.children?.forEach(child => {
      components.add(child.type)
    })
  }
  
  spec.sections.forEach(collectComponents)
  
  // Generate import statements
  const uiComponents: string[] = []
  const dataComponents: string[] = []
  
  components.forEach(comp => {
    if (['DataTable', 'Form'].includes(comp)) {
      dataComponents.push(comp)
    } else {
      uiComponents.push(comp)
    }
  })
  
  let imports = ''
  
  if (uiComponents.length > 0) {
    imports += `import { ${uiComponents.join(', ')} } from '@ssot-ui/shared'\n`
  }
  
  if (dataComponents.length > 0) {
    imports += `import { ${dataComponents.join(', ')} } from '@/components/ssot'\n`
  }
  
  return imports
}

/**
 * Generate layout wrapper code
 */
function generateLayoutWrapper(layout: string): { open: string, close: string } {
  switch (layout) {
    case 'dashboard':
      return {
        open: `<DashboardLayout
      header={<Header title="Dashboard" />}
      sidebar={<Sidebar sections={[]} />}
    >`,
        close: '</DashboardLayout>'
      }
    
    case 'landing':
      return {
        open: `<LandingLayout
      header={<Header />}
      footer={<Footer />}
    >`,
        close: '</LandingLayout>'
      }
    
    case 'auth':
      return {
        open: '<AuthLayout>',
        close: '</AuthLayout>'
      }
    
    default:
      return { open: '<>', close: '</>' }
  }
}

/**
 * Generate section code
 */
function generateSection(section: SectionSpec, schema: ParsedSchema): string {
  switch (section.type) {
    case 'header':
      return generateHeaderSection(section)
    
    case 'hero':
      return generateHeroSection(section)
    
    case 'content':
      return generateContentSection(section, schema)
    
    case 'custom':
      return generateCustomSection(section, schema)
    
    default:
      return ''
  }
}

function generateHeaderSection(section: SectionSpec): string {
  const props = section.props || {}
  return `
      <Header
        ${Object.entries(props).map(([key, value]) => 
          `${key}={${JSON.stringify(value)}}`
        ).join('\n        ')}
      />`
}

function generateHeroSection(section: SectionSpec): string {
  const props = section.props || {}
  return `
      <Hero
        ${Object.entries(props).map(([key, value]) => 
          typeof value === 'string' 
            ? `${key}="${value}"`
            : `${key}={${JSON.stringify(value)}}`
        ).join('\n        ')}
      />`
}

function generateContentSection(section: SectionSpec, schema: ParsedSchema): string {
  if (!section.children || section.children.length === 0) {
    return ''
  }
  
  return `
      <Container>
        <Stack spacing={8}>
          ${section.children.map(child => generateComponent(child, schema)).join('\n          ')}
        </Stack>
      </Container>`
}

function generateCustomSection(section: SectionSpec, schema: ParsedSchema): string {
  if (!section.children) return ''
  
  return section.children.map(child => generateComponent(child, schema)).join('\n')
}

/**
 * Generate component code from spec
 */
function generateComponent(spec: ComponentSpec, schema: ParsedSchema): string {
  const props = spec.props || {}
  const propsString = Object.entries(props)
    .map(([key, value]) => {
      if (typeof value === 'string') {
        return `${key}="${value}"`
      }
      return `${key}={${JSON.stringify(value)}}`
    })
    .join(' ')
  
  if (typeof spec.children === 'string') {
    return `<${spec.type} ${propsString}>${spec.children}</${spec.type}>`
  }
  
  if (Array.isArray(spec.children) && spec.children.length > 0) {
    const childrenCode = spec.children
      .map(child => generateComponent(child, schema))
      .join('\n')
    
    return `<${spec.type} ${propsString}>
  ${childrenCode}
</${spec.type}>`
  }
  
  return `<${spec.type} ${propsString} />`
}

/**
 * Generate example page spec
 */
export function createExamplePageSpec(): PageSpec {
  return {
    layout: 'dashboard',
    title: 'Dashboard',
    sections: [
      {
        type: 'header',
        props: {
          title: 'Dashboard',
          links: [
            { label: 'Home', href: '/' },
            { label: 'Posts', href: '/posts' },
            { label: 'Users', href: '/users' }
          ]
        }
      },
      {
        type: 'content',
        children: [
          {
            type: 'Grid',
            props: { cols: 3, gap: 6 },
            children: [
              {
                type: 'Card',
                props: { padding: 'lg' },
                children: 'Total Users: 1,234'
              },
              {
                type: 'Card',
                props: { padding: 'lg' },
                children: 'Total Posts: 5,678'
              },
              {
                type: 'Card',
                props: { padding: 'lg' },
                children: 'Active Sessions: 89'
              }
            ]
          },
          {
            type: 'DataTable',
            props: {
              model: 'post',
              columns: [
                { key: 'title', label: 'Title' },
                { key: 'author', label: 'Author' },
                { key: 'createdAt', label: 'Created' }
              ]
            }
          }
        ]
      }
    ]
  }
}

