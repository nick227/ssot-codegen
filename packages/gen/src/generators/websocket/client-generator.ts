/**
 * WebSocket Client Generator
 * Generates client-side SDK with WebSocket support
 */

import type { ParsedModel } from '../../types/schema.js'
import type { WebSocketConfig } from './types.js'

export function generateWebSocketClient(
  models: ParsedModel[],
  config: WebSocketConfig
): Map<string, string> {
  const files = new Map<string, string>()
  
  // Only generate for models with WebSocket config
  const wsModels = models.filter(m => config.pubsub.models[m.name])
  
  for (const model of wsModels) {
    const modelConfig = config.pubsub.models[model.name]
    files.set(
      `${model.name.toLowerCase()}-ws-client.ts`,
      generateModelWSClient(model, modelConfig, config)
    )
  }
  
  return files
}

function generateModelWSClient(
  model: ParsedModel,
  modelConfig: any,
  config: WebSocketConfig
): string {
  const modelName = model.name
  const modelLower = model.name.toLowerCase()
  
  return `/**
 * ${modelName} WebSocket Client
 * Generated by SSOT CodeGen
 */

import { WebSocketTransport, HybridDataClient, HTTPTransport } from '@ssot/sdk-runtime'
import { baseClient } from './base-client.js'

const wsUrl = '${config.url ?? `ws://localhost:${config.port ?? 3001}${config.path ?? '/ws'}`}'

// HTTP transport (always available)
const httpTransport = new HTTPTransport(
  baseClient,
  '/api/${modelLower}'
)

// WebSocket transport (optional)
const wsTransport = typeof WebSocket !== 'undefined'
  ? new WebSocketTransport(wsUrl, '${modelName}')
  : undefined

// Hybrid client (smart routing)
export const ${modelLower}Client = new HybridDataClient(
  httpTransport,
  wsTransport
)
`
}

