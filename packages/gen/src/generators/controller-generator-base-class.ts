/**
 * Base Class Controller Generator - Generates minimal controllers using BaseCRUDController
 * Reduces generated code by 80-85%
 */

import type { ParsedModel, ParsedSchema } from '../dmmf-parser.js'
import { analyzeModel } from '../utils/relationship-analyzer.js'

/**
 * Generate controller using BaseCRUDController (minimal boilerplate)
 */
export function generateBaseClassController(
  model: ParsedModel,
  schema: ParsedSchema,
  framework: 'express' | 'fastify' = 'express'
): string {
  if (framework === 'fastify') {
    // For now, fastify will use old generator
    // TODO: Implement Fastify base class
    return generateExpressBaseClassController(model, schema)
  }
  
  return generateExpressBaseClassController(model, schema)
}

/**
 * Generate Express controller using base class
 */
function generateExpressBaseClassController(
  model: ParsedModel,
  schema: ParsedSchema
): string {
  const analysis = analyzeModel(model, schema)
  const modelLower = model.name.toLowerCase()
  const idType = model.idField?.type === 'String' ? 'string' : 'number'
  
  const imports = generateImports(model, modelLower, analysis)
  const crudSetup = generateCRUDSetup(model, modelLower, idType)
  const crudExports = generateCRUDExports(model, modelLower)
  const domainMethods = generateDomainMethodExports(model, analysis, modelLower, idType)
  
  return `// @generated
// This file is automatically generated. Do not edit manually.

${imports}

${crudSetup}

${crudExports}${domainMethods}
`
}

/**
 * Generate imports (conditional based on domain methods)
 */
function generateImports(model: ParsedModel, modelLower: string, analysis: ReturnType<typeof analyzeModel>): string {
  // Check if we need helper functions
  const needsHelpers = 
    analysis.specialFields.slug ||
    analysis.specialFields.published ||
    analysis.specialFields.views ||
    analysis.specialFields.approved ||
    analysis.specialFields.deletedAt ||
    analysis.specialFields.parentId
  
  const helperImports = needsHelpers
    ? `,
  createDomainMethodController,
  createVoidDomainMethodController,
  createListMethodController`
    : ''
  
  return `import {
  BaseCRUDController${helperImports}
} from '../../base/index.js'
import { ${modelLower}Service } from '../../services/${modelLower}/index.js'
import {
  ${model.name}CreateSchema,
  ${model.name}UpdateSchema,
  ${model.name}QuerySchema
} from '../../validators/${modelLower}/index.js'`
}

/**
 * Generate CRUD setup using base class
 */
function generateCRUDSetup(model: ParsedModel, modelLower: string, idType: string): string {
  return `/**
 * ${model.name} CRUD Controller
 * Using BaseCRUDController to eliminate boilerplate
 */
const ${modelLower}CRUD = new BaseCRUDController(
  ${modelLower}Service,
  {
    create: ${model.name}CreateSchema,
    update: ${model.name}UpdateSchema,
    query: ${model.name}QuerySchema
  },
  {
    modelName: '${model.name}',
    idType: '${idType}'
  }
)`
}

/**
 * Generate CRUD method exports
 */
function generateCRUDExports(model: ParsedModel, modelLower: string): string {
  return `
// Standard CRUD operations
export const list${model.name}s = ${modelLower}CRUD.list
export const get${model.name} = ${modelLower}CRUD.getById
export const create${model.name} = ${modelLower}CRUD.create
export const update${model.name} = ${modelLower}CRUD.update
export const delete${model.name} = ${modelLower}CRUD.deleteRecord
export const count${model.name}s = ${modelLower}CRUD.count`
}

/**
 * Generate domain method exports
 */
function generateDomainMethodExports(
  model: ParsedModel,
  analysis: ReturnType<typeof analyzeModel>,
  modelLower: string,
  idType: string
): string {
  const methods: string[] = []
  
  // Slug lookup
  if (analysis.specialFields.slug) {
    methods.push(`
/**
 * Get ${model.name} by slug
 */
export const get${model.name}BySlug = createDomainMethodController(
  ${modelLower}Service.findBySlug,
  {
    modelName: '${model.name}',
    methodName: 'get${model.name}BySlug',
    idType: 'string',
    paramName: 'slug'
  }
)`)
  }
  
  // Published filtering
  if (analysis.specialFields.published) {
    methods.push(`
/**
 * List published ${model.name} records
 */
export const listPublished${model.name}s = createListMethodController(
  ${modelLower}Service.listPublished,
  ${model.name}QuerySchema,
  {
    modelName: '${model.name}',
    methodName: 'listPublished${model.name}s'
  }
)

/**
 * Publish ${model.name}
 */
export const publish${model.name} = createDomainMethodController(
  ${modelLower}Service.publish,
  {
    modelName: '${model.name}',
    methodName: 'publish${model.name}',
    idType: '${idType}'
  }
)

/**
 * Unpublish ${model.name}
 */
export const unpublish${model.name} = createDomainMethodController(
  ${modelLower}Service.unpublish,
  {
    modelName: '${model.name}',
    methodName: 'unpublish${model.name}',
    idType: '${idType}'
  }
)`)
  }
  
  // View counter
  if (analysis.specialFields.views) {
    methods.push(`
/**
 * Increment ${model.name} views
 */
export const increment${model.name}Views = createVoidDomainMethodController(
  ${modelLower}Service.incrementViews,
  {
    modelName: '${model.name}',
    methodName: 'increment${model.name}Views',
    idType: '${idType}'
  }
)`)
  }
  
  // Approval workflow
  if (analysis.specialFields.approved) {
    methods.push(`
/**
 * Approve ${model.name}
 */
export const approve${model.name} = createDomainMethodController(
  ${modelLower}Service.approve,
  {
    modelName: '${model.name}',
    methodName: 'approve${model.name}',
    idType: '${idType}'
  }
)

/**
 * Reject ${model.name}
 */
export const reject${model.name} = createDomainMethodController(
  ${modelLower}Service.reject,
  {
    modelName: '${model.name}',
    methodName: 'reject${model.name}',
    idType: '${idType}'
  }
)`)
  }
  
  // Soft delete
  if (analysis.specialFields.deletedAt) {
    methods.push(`
/**
 * List ${model.name} records with deleted
 */
export const list${model.name}sWithDeleted = createListMethodController(
  ${modelLower}Service.listWithDeleted,
  ${model.name}QuerySchema,
  {
    modelName: '${model.name}',
    methodName: 'list${model.name}sWithDeleted'
  }
)

/**
 * Soft delete ${model.name}
 */
export const softDelete${model.name} = createVoidDomainMethodController(
  ${modelLower}Service.softDelete,
  {
    modelName: '${model.name}',
    methodName: 'softDelete${model.name}',
    idType: '${idType}'
  }
)

/**
 * Restore ${model.name}
 */
export const restore${model.name} = createDomainMethodController(
  ${modelLower}Service.restore,
  {
    modelName: '${model.name}',
    methodName: 'restore${model.name}',
    idType: '${idType}'
  }
)`)
  }
  
  // Threading
  if (analysis.specialFields.parentId) {
    methods.push(`
/**
 * Get ${model.name} thread (with replies)
 */
export const get${model.name}Thread = createDomainMethodController(
  ${modelLower}Service.getThread,
  {
    modelName: '${model.name}',
    methodName: 'get${model.name}Thread',
    idType: '${idType}'
  }
)`)
  }
  
  return methods.length > 0 ? '\n' + methods.join('\n') : ''
}


