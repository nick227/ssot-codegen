/**
 * Route Generator - Comprehensive Tests
 * Uses new test utilities for better coverage
 */

import { describe, it, expect, beforeEach } from 'vitest'
import { RouteGenerator } from '../route-generator-v2.js'
import {
  models,
  field,
  ModelBuilder,
  assertIncludes,
  assertExcludes,
  assertValidTypeScript,
  extractImports,
  extractExports,
  normalizeGenerated,
  minimalSnapshot
} from '../../__tests__/index.js'

describe('RouteGenerator - Comprehensive Tests', () => {
  describe('Basic Route Generation - Express', () => {
    let generator: RouteGenerator

    beforeEach(() => {
      generator = new RouteGenerator({ model: models.todo(), framework: 'express' })
    })

    it('should generate routes file', () => {
      const output = generator.generate()

      expect(output.files.size).toBe(1)
      expect(output.files.has('todo.routes.ts')).toBe(true)
    })

    it('should generate valid TypeScript', () => {
      const output = generator.generate()

      output.files.forEach((content) => {
        assertValidTypeScript(content)
      })
    })

    it('should include generation markers', () => {
      const output = generator.generate()

      output.files.forEach((content) => {
        expect(content).toContain('// @generated')
        expect(content).toContain('// This file is automatically generated')
      })
    })

    it('should import Express Router', () => {
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain("import { Router } from 'express'")
    })

    it('should create Router instance', () => {
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      assertIncludes(content, [
        'export const todoRouter = Router()',
        'todoRouter.get(',
        'todoRouter.post('
      ])
    })
  })

  describe('Express - Route Definitions', () => {
    it('should define all CRUD routes', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      assertIncludes(content, [
        "todoRouter.get('/', todoController.listTodos)",
        "todoRouter.get('/:id', todoController.getTodo)",
        "todoRouter.post('/', todoController.createTodo)",
        "todoRouter.put('/:id', todoController.updateTodo)",
        "todoRouter.delete('/:id', todoController.deleteTodo)",
        "todoRouter.get('/meta/count', todoController.countTodos)"
      ])
    })

    it('should import controller', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain("import * as todoController from '@gen/controllers/todo'")
    })

    it('should define routes in correct order', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      const listPos = content.indexOf("todoRouter.get('/',")
      const getPos = content.indexOf("todoRouter.get('/:id',")
      const createPos = content.indexOf("todoRouter.post('/',")
      const updatePos = content.indexOf("todoRouter.put('/:id',")
      const deletePos = content.indexOf("todoRouter.delete('/:id',")
      const countPos = content.indexOf("todoRouter.get('/meta/count',")

      // All routes should be defined
      expect(listPos).toBeGreaterThan(0)
      expect(getPos).toBeGreaterThan(0)
      expect(createPos).toBeGreaterThan(0)
      expect(updatePos).toBeGreaterThan(0)
      expect(deletePos).toBeGreaterThan(0)
      expect(countPos).toBeGreaterThan(0)
    })

    it('should include route comments', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      assertIncludes(content, [
        '// List all Todo records',
        '// Get Todo by ID',
        '// Create Todo',
        '// Update Todo',
        '// Delete Todo',
        '// Count Todo records'
      ])
    })
  })

  describe('Basic Route Generation - Fastify', () => {
    it('should generate Fastify routes plugin', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'fastify' })
      const output = generator.generate()

      expect(output.files.size).toBe(1)
      expect(output.files.has('todo.routes.ts')).toBe(true)
    })

    it('should import Fastify types', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain("import type { FastifyInstance } from 'fastify'")
    })

    it('should export async plugin function', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      assertIncludes(content, [
        'export async function todoRoutes(fastify: FastifyInstance)',
        'async function'
      ])
    })

    it('should import controller', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain("import * as todoController from '@gen/controllers/todo'")
    })
  })

  describe('Fastify - Route Definitions', () => {
    it('should define all CRUD routes with Fastify API', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      assertIncludes(content, [
        "fastify.get('/', todoController.listTodos)",
        "fastify.get<{ Params: { id: string } }>('/:id', todoController.getTodo)",
        "fastify.post('/', todoController.createTodo)",
        "fastify.put<{ Params: { id: string } }>('/:id', todoController.updateTodo)",
        "fastify.delete<{ Params: { id: string } }>('/:id', todoController.deleteTodo)",
        "fastify.get('/meta/count', todoController.countTodos)"
      ])
    })

    it('should use typed route parameters for ID routes', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      // Fastify can have typed params
      expect(content).toContain("fastify.get<{ Params: { id: string } }>('/:id'")
      expect(content).toContain("fastify.put<{ Params: { id: string } }>('/:id'")
      expect(content).toContain("fastify.delete<{ Params: { id: string } }>('/:id'")
    })

    it('should include route comments', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      assertIncludes(content, [
        '// List all Todo records',
        '// Get Todo by ID',
        '// Create Todo',
        '// Update Todo',
        '// Delete Todo'
      ])
    })
  })

  describe('Route Paths', () => {
    it('should use root path for list and create', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain("todoRouter.get('/', todoController.listTodos)")
      expect(content).toContain("todoRouter.post('/', todoController.createTodo)")
    })

    it('should use /:id path for get, update, delete', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain("todoRouter.get('/:id', todoController.getTodo)")
      expect(content).toContain("todoRouter.put('/:id', todoController.updateTodo)")
      expect(content).toContain("todoRouter.delete('/:id', todoController.deleteTodo)")
    })

    it('should use /meta/count path for count', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain("todoRouter.get('/meta/count', todoController.countTodos)")
    })

    it('should include /meta/count route', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain("/meta/count")
      expect(content).toContain("todoRouter.get('/meta/count'")
    })
  })

  describe('HTTP Methods', () => {
    it('should use GET for list and get by ID', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      const getMethods = (content.match(/todoRouter\.get\(/g) || []).length
      expect(getMethods).toBeGreaterThanOrEqual(3) // list, get, count
    })

    it('should use POST for create', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain("todoRouter.post('/', todoController.createTodo)")
    })

    it('should use PUT for update', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain("todoRouter.put('/:id', todoController.updateTodo)")
    })

    it('should use DELETE for delete', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain("todoRouter.delete('/:id', todoController.deleteTodo)")
    })
  })

  describe('Exports', () => {
    it('should export router for Express', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain('export const todoRouter = Router()')
    })

    it('should export async function for Fastify', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain('export async function todoRoutes')
    })

    it('should have correct export list', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const exports = generator.getExports()

      expect(exports).toContain('todoRouter')
    })
  })

  describe('Edge Cases', () => {
    it('should handle model with only ID field', () => {
      const model = new ModelBuilder()
        .name('MinimalModel')
        .withIntId()
        .build()

      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('minimalmodel.routes.ts')!

      expect(content).toContain('export const minimalmodelRouter = Router()')
      assertValidTypeScript(content)
    })

    it('should handle UUID ID type', () => {
      const model = models.user()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('user.routes.ts')!

      // Routes are the same regardless of ID type
      expect(content).toContain("userRouter.get('/:id', userController.getUser)")
      assertValidTypeScript(content)
    })

    it('should handle complex model names', () => {
      const model = new ModelBuilder()
        .name('BlogPost')
        .withIntId()
        .addField(field.string('title'))
        .build()

      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('blogpost.routes.ts')!

      assertIncludes(content, [
        'import * as blogpostController',
        'export const blogpostRouter = Router()',
        'blogpostRouter.get('
      ])
    })
  })

  describe('Framework Differences', () => {
    it('should generate different patterns for Express vs Fastify', () => {
      const model = models.todo()

      const expressGen = new RouteGenerator({ model, framework: 'express' })
      const fastifyGen = new RouteGenerator({ model, framework: 'fastify' })

      const expressContent = expressGen.generate().files.get('todo.routes.ts')!
      const fastifyContent = fastifyGen.generate().files.get('todo.routes.ts')!

      // Express uses Router
      assertIncludes(expressContent, [
        "import { Router } from 'express'",
        'export const todoRouter = Router()',
        'todoRouter.get(',
        'todoRouter.post('
      ])

      // Fastify uses plugin function
      assertIncludes(fastifyContent, [
        "import type { FastifyInstance } from 'fastify'",
        'export async function todoRoutes(fastify: FastifyInstance)',
        'fastify.get(',
        'fastify.post('
      ])

      // Express should NOT have Fastify patterns
      expect(expressContent).not.toContain('FastifyInstance')
      expect(expressContent).not.toContain('async function todoRoutes')

      // Fastify should NOT have Express Router export pattern
      expect(fastifyContent).not.toContain('= Router()')
      expect(fastifyContent).not.toContain('todoRouter.get')
    })
  })

  describe('Barrel Export', () => {
    it('should generate barrel export', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const barrel = generator.generateBarrel()

      assertIncludes(barrel, [
        '// @generated barrel',
        "export * from './todo.routes.js'"
      ])

      assertValidTypeScript(barrel)
    })
  })

  describe('Controller References', () => {
    it('should reference all controller functions', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      assertIncludes(content, [
        'todoController.listTodos',
        'todoController.getTodo',
        'todoController.createTodo',
        'todoController.updateTodo',
        'todoController.deleteTodo',
        'todoController.countTodos'
      ])
    })

    it('should use consistent controller naming', () => {
      const model = new ModelBuilder()
        .name('Product')
        .withIntId()
        .addField(field.string('name'))
        .build()

      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('product.routes.ts')!

      assertIncludes(content, [
        'import * as productController',
        'productController.listProducts',
        'productController.getProduct'
      ])
    })
  })

  describe('Snapshot Testing', () => {
    it('should match Express routes snapshot', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      const normalized = normalizeGenerated(content)
      expect(normalized).toMatchSnapshot()
    })

    it('should match Fastify routes snapshot', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      const normalized = normalizeGenerated(content)
      expect(normalized).toMatchSnapshot()
    })

    it('should match minimal snapshot structure', () => {
      const model = models.post()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()

      const snapshots = Array.from(output.files.entries()).map(([filename, content]) => ({
        filename,
        snapshot: minimalSnapshot(content)
      }))

      expect(snapshots).toMatchSnapshot()
    })
  })

  describe('Metadata', () => {
    it('should include file count in metadata', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()

      expect(output.metadata?.fileCount).toBe(1)
    })

    it('should include line count in metadata', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()

      expect(output.metadata?.lineCount).toBeGreaterThan(0)
    })

    it('should track total lines correctly', () => {
      const model = models.post()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()

      const content = output.files.get('post.routes.ts')!
      const manualCount = content.split('\n').length

      expect(output.metadata?.lineCount).toBe(manualCount)
    })
  })

  describe('Import/Export Analysis', () => {
    it('should extract imports correctly - Express', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      const imports = extractImports(content)
      expect(imports).toContain('express')
      expect(imports).toContain('@gen/controllers/todo')
    })

    it('should extract imports correctly - Fastify', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      const imports = extractImports(content)
      expect(imports).toContain('fastify')
      expect(imports).toContain('@gen/controllers/todo')
    })

    it('should extract exports correctly - Express', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      // Express exports the router
      expect(content).toContain('export const todoRouter = Router()')
    })

    it('should extract exports correctly - Fastify', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      // Fastify exports async function
      expect(content).toContain('export async function todoRoutes')
    })
  })

  describe('Complex Models', () => {
    it('should handle blog post model - Express', () => {
      const model = new ModelBuilder()
        .name('BlogPost')
        .withIntId()
        .addField(field.string('title'))
        .addField(field.string('slug'))
        .addField(field.relation('author', 'User'))
        .withTimestamps()
        .build()

      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('blogpost.routes.ts')!

      assertValidTypeScript(content)
      assertIncludes(content, [
        'import * as blogpostController',
        'export const blogpostRouter = Router()',
        'blogpostController.listBlogPosts',
        'blogpostController.getBlogPost'
      ])
    })

    it('should handle e-commerce product model - Fastify', () => {
      const model = new ModelBuilder()
        .name('Product')
        .withIntId()
        .addField(field.string('sku'))
        .addField(field.string('name'))
        .addField(field.int('stock'))
        .withTimestamps()
        .build()

      const generator = new RouteGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('product.routes.ts')!

      assertValidTypeScript(content)
      assertIncludes(content, [
        'export async function productRoutes(fastify: FastifyInstance)',
        'import * as productController',
        'fastify.get(',
        'productController.listProducts'
      ])
    })
  })

  describe('Validation', () => {
    it('should validate model has fields', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const errors = generator.validate()

      expect(errors).toEqual([])
    })
  })

  describe('Route Comments', () => {
    it('should include descriptive comments for each route', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      // Should have comments above each route
      const commentCount = (content.match(/\/\/ /g) || []).length
      expect(commentCount).toBeGreaterThanOrEqual(6) // One for each route
    })
  })

  describe('File Naming', () => {
    it('should use lowercase model name for file', () => {
      const model = new ModelBuilder()
        .name('BlogPost')
        .withIntId()
        .addField(field.string('title'))
        .build()

      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()

      expect(output.files.has('blogpost.routes.ts')).toBe(true)
    })

    it('should use .routes.ts extension', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()

      output.files.forEach((content, filename) => {
        expect(filename).toMatch(/\.routes\.ts$/)
      })
    })
  })

  describe('Router Naming - Express', () => {
    it('should use modelRouter naming convention', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain('export const todoRouter = Router()')
    })

    it('should match router name to model', () => {
      const model = new ModelBuilder()
        .name('Product')
        .withIntId()
        .addField(field.string('name'))
        .build()

      const generator = new RouteGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('product.routes.ts')!

      expect(content).toContain('export const productRouter = Router()')
    })
  })

  describe('Function Naming - Fastify', () => {
    it('should use modelRoutes naming convention', () => {
      const model = models.todo()
      const generator = new RouteGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.routes.ts')!

      expect(content).toContain('export async function todoRoutes')
    })

    it('should match function name to model', () => {
      const model = new ModelBuilder()
        .name('Product')
        .withIntId()
        .addField(field.string('name'))
        .build()

      const generator = new RouteGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('product.routes.ts')!

      expect(content).toContain('export async function productRoutes')
    })
  })
})

