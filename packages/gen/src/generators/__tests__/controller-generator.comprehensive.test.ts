/**
 * Controller Generator - Comprehensive Tests
 * Uses new test utilities for better coverage
 */

import { describe, it, expect, beforeEach } from 'vitest'
import { ControllerGenerator } from '../controller-generator-v2.js'
import {
  models,
  field,
  ModelBuilder,
  assertIncludes,
  assertExcludes,
  assertValidTypeScript,
  extractImports,
  extractExports,
  normalizeGenerated,
  minimalSnapshot
} from '../../__tests__/index.js'

describe('ControllerGenerator - Comprehensive Tests', () => {
  describe('Basic Controller Generation - Express', () => {
    let generator: ControllerGenerator

    beforeEach(() => {
      generator = new ControllerGenerator({ model: models.todo(), framework: 'express' })
    })

    it('should generate controller file', () => {
      const output = generator.generate()

      expect(output.files.size).toBe(1)
      expect(output.files.has('todo.controller.ts')).toBe(true)
    })

    it('should generate valid TypeScript', () => {
      const output = generator.generate()

      output.files.forEach((content) => {
        assertValidTypeScript(content)
      })
    })

    it('should include generation markers', () => {
      const output = generator.generate()

      output.files.forEach((content) => {
        expect(content).toContain('// @generated')
        expect(content).toContain('// This file is automatically generated')
      })
    })

    it('should export all handler functions', () => {
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'export const listTodos',
        'export const getTodo',
        'export const createTodo',
        'export const updateTodo',
        'export const deleteTodo',
        'export const countTodos'
      ])
    })

    it('should have all CRUD handlers', () => {
      const exports = generator.getExports()

      expect(exports).toContain('listTodos')
      expect(exports).toContain('getTodo')
      expect(exports).toContain('createTodo')
      expect(exports).toContain('updateTodo')
      expect(exports).toContain('deleteTodo')
      expect(exports).toContain('countTodos')
    })
  })

  describe('Express - List Handler', () => {
    it('should generate list handler with validation', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'export const listTodos = async (req: Request, res: Response)',
        'TodoQuerySchema.parse(req.query)',
        'await todoService.list(query)',
        'return res.json(result)'
      ])
    })

    it('should handle validation errors', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'try {',
        'catch (error)',
        'if (error instanceof ZodError)',
        'return res.status(400).json({ error: \'Validation Error\'',
        'details: error.errors'
      ])
    })

    it('should handle server errors', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'console.error(error)',
        'return res.status(500).json({ error: \'Internal Server Error\' })'
      ])
    })

    it('should include JSDoc comment', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        '/**',
        '* List all Todo records',
        '*/'
      ])
    })
  })

  describe('Express - Get Handler', () => {
    it('should generate get handler with Int ID', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'export const getTodo',
        'async (req: Request<{ Params: { id: string } }>, res: Response)',
        'const id = parseInt(req.params.id, 10)',
        'if (isNaN(id))',
        'await todoService.findById(id)'
      ])
    })

    it('should generate get handler with String ID', () => {
      const model = models.user()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('user.controller.ts')!

      assertIncludes(content, [
        'export const getUser',
        'const id = req.params.id',
        'await userService.findById(id)'
      ])

      // Should NOT have parseInt or isNaN for string IDs
      expect(content).not.toContain('parseInt(req.params.id')
      expect(content).not.toContain('if (isNaN(id))')
    })

    it('should handle not found error', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'if (!item)',
        'return res.status(404).json({ error: \'Todo not found\' })'
      ])
    })

    it('should return item on success', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain('return res.json(item)')
    })
  })

  describe('Express - Create Handler', () => {
    it('should generate create handler', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'export const createTodo = async (req: Request, res: Response)',
        'TodoCreateSchema.parse(req.body)',
        'await todoService.create(data)',
        'return res.status(201).json(item)'
      ])
    })

    it('should validate request body', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain('TodoCreateSchema.parse(req.body)')
    })

    it('should return 201 status', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain('return res.status(201).json(item)')
    })
  })

  describe('Express - Update Handler', () => {
    it('should generate update handler with Int ID', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'export const updateTodo',
        'const id = parseInt(req.params.id, 10)',
        'TodoUpdateSchema.parse(req.body)',
        'await todoService.update(id, data)'
      ])
    })

    it('should validate ID format', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'if (isNaN(id))',
        'return res.status(400).json({ error: \'Invalid ID format\' })'
      ])
    })

    it('should handle not found', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'if (!item)',
        'return res.status(404).json({ error: \'Todo not found\' })'
      ])
    })
  })

  describe('Express - Delete Handler', () => {
    it('should generate delete handler', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'export const deleteTodo',
        'const id = parseInt(req.params.id, 10)',
        'await todoService.delete(id)'
      ])
    })

    it('should return 204 on success', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain('return res.status(204).send()')
    })

    it('should handle not found', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'if (!deleted)',
        'return res.status(404).json({ error: \'Todo not found\' })'
      ])
    })
  })

  describe('Express - Count Handler', () => {
    it('should generate count handler', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'export const countTodos',
        'await todoService.count()',
        'return res.json({ total })'
      ])
    })
  })

  describe('Basic Controller Generation - Fastify', () => {
    it('should generate Fastify controller', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()

      expect(output.files.size).toBe(1)
      expect(output.files.has('todo.controller.ts')).toBe(true)
    })

    it('should import Fastify types', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain("import type { FastifyRequest, FastifyReply } from 'fastify'")
    })

    it('should use Fastify parameter names', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'async (request: FastifyRequest, reply: FastifyReply)',
        'request.query',
        'request.body',
        'request.params'
      ])
    })
  })

  describe('Fastify - List Handler', () => {
    it('should generate list handler', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'export const listTodos',
        'request: FastifyRequest, reply: FastifyReply',
        'TodoQuerySchema.parse(request.query)',
        'await todoService.list(query)',
        'return result'
      ])
    })

    it('should return result directly', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      // Fastify allows direct return for 200 responses
      expect(content).toContain('return result')
    })
  })

  describe('Fastify - Get Handler', () => {
    it('should use typed params', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain('FastifyRequest<{ Params: { id: string } }>')
    })

    it('should use reply.code() for status codes', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'reply.code(400).send(',
        'reply.code(404).send('
      ])
    })

    it('should return item directly on success', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain('return item')
    })
  })

  describe('Fastify - Create Handler', () => {
    it('should use reply.code(201)', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain('return reply.code(201).send(item)')
    })
  })

  describe('Fastify - Delete Handler', () => {
    it('should use reply.code(204)', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain('reply.code(204).send()')
    })
  })

  describe('Imports - Express', () => {
    it('should import Express types', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain("import type { Request, Response } from 'express'")
    })

    it('should import service', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain("import { todoService } from '@/services/todo'")
    })

    it('should import validators', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        "import { TodoCreateSchema, TodoUpdateSchema, TodoQuerySchema } from '@/validators/todo'"
      ])
    })

    it('should import ZodError', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain("import { ZodError } from 'zod'")
    })
  })

  describe('Imports - Fastify', () => {
    it('should import Fastify types', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain("import type { FastifyRequest, FastifyReply } from 'fastify'")
    })

    it('should import service and validators', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        "import { todoService } from '@/services/todo'",
        "import { TodoCreateSchema, TodoUpdateSchema, TodoQuerySchema } from '@/validators/todo'"
      ])
    })
  })

  describe('Error Handling', () => {
    it('should handle validation errors', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'if (error instanceof ZodError)',
        'status(400)',
        'Validation Error'
      ])
    })

    it('should handle not found errors', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'if (!item)',
        'status(404)',
        'not found'
      ])
    })

    it('should handle server errors', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'console.error(error)',
        'status(500)',
        'Internal Server Error'
      ])
    })

    it('should log errors', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      // Count console.error calls
      const errorCalls = (content.match(/console\.error/g) || []).length
      expect(errorCalls).toBeGreaterThanOrEqual(6) // One per handler
    })
  })

  describe('JSDoc Comments', () => {
    it('should include JSDoc for all handlers', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        '* List all Todo records',
        '* Get Todo by ID',
        '* Create Todo',
        '* Update Todo',
        '* Delete Todo',
        '* Count Todo records'
      ])
    })

    it('should use proper JSDoc format', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      const docOpenings = (content.match(/\/\*\*/g) || []).length
      expect(docOpenings).toBeGreaterThanOrEqual(6)
    })
  })

  describe('Edge Cases', () => {
    it('should handle model with only ID field', () => {
      const model = new ModelBuilder()
        .name('MinimalModel')
        .withIntId()
        .build()

      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('minimalmodel.controller.ts')!

      expect(content).toContain('export const listMinimalModels')
      assertValidTypeScript(content)
    })

    it('should handle UUID ID type', () => {
      const model = models.user()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('user.controller.ts')!

      // Should use string ID
      expect(content).toContain('const id = req.params.id')
      expect(content).not.toContain('parseInt(')
      expect(content).not.toContain('isNaN(id)')
    })

    it('should handle complex model names', () => {
      const model = new ModelBuilder()
        .name('BlogPost')
        .withIntId()
        .addField(field.string('title'))
        .build()

      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('blogpost.controller.ts')!

      assertIncludes(content, [
        'export const listBlogPosts',
        'export const getBlogPost',
        'export const createBlogPost',
        'blogpostService.'
      ])
    })
  })

  describe('Framework Differences', () => {
    it('should generate different patterns for Express vs Fastify', () => {
      const model = models.todo()

      const expressGen = new ControllerGenerator({ model, framework: 'express' })
      const fastifyGen = new ControllerGenerator({ model, framework: 'fastify' })

      const expressContent = expressGen.generate().files.get('todo.controller.ts')!
      const fastifyContent = fastifyGen.generate().files.get('todo.controller.ts')!

      // Express uses req/res
      expect(expressContent).toContain('req: Request, res: Response')
      expect(expressContent).toContain('req.query')
      expect(expressContent).toContain('res.json(')
      expect(expressContent).toContain('res.status(')

      // Fastify uses request/reply
      expect(fastifyContent).toContain('request: FastifyRequest, reply: FastifyReply')
      expect(fastifyContent).toContain('request.query')
      expect(fastifyContent).toContain('reply.code(')
      expect(fastifyContent).toContain('return result')
    })
  })

  describe('Barrel Export', () => {
    it('should generate barrel export', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const barrel = generator.generateBarrel()

      assertIncludes(barrel, [
        '// @generated barrel',
        "export * from './todo.controller.js'"
      ])

      assertValidTypeScript(barrel)
    })
  })

  describe('Snapshot Testing', () => {
    it('should match Express controller snapshot', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      const normalized = normalizeGenerated(content)
      expect(normalized).toMatchSnapshot()
    })

    it('should match Fastify controller snapshot', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      const normalized = normalizeGenerated(content)
      expect(normalized).toMatchSnapshot()
    })

    it('should match minimal snapshot structure', () => {
      const model = models.post()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()

      const snapshots = Array.from(output.files.entries()).map(([filename, content]) => ({
        filename,
        snapshot: minimalSnapshot(content)
      }))

      expect(snapshots).toMatchSnapshot()
    })
  })

  describe('Metadata', () => {
    it('should include file count in metadata', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()

      expect(output.metadata?.fileCount).toBe(1)
    })

    it('should include line count in metadata', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()

      expect(output.metadata?.lineCount).toBeGreaterThan(0)
    })

    it('should track total lines correctly', () => {
      const model = models.post()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()

      const content = output.files.get('post.controller.ts')!
      const manualCount = content.split('\n').length

      expect(output.metadata?.lineCount).toBe(manualCount)
    })
  })

  describe('Import/Export Analysis', () => {
    it('should extract imports correctly', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      const imports = extractImports(content)
      expect(imports).toContain('express')
      expect(imports).toContain('@/services/todo')
      expect(imports).toContain('@/validators/todo')
      expect(imports).toContain('zod')
    })

    it('should extract exports correctly', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      const exports = extractExports(content)
      expect(exports).toContain('listTodos')
      expect(exports).toContain('getTodo')
      expect(exports).toContain('createTodo')
      expect(exports).toContain('updateTodo')
      expect(exports).toContain('deleteTodo')
      expect(exports).toContain('countTodos')
    })
  })

  describe('Complex Models', () => {
    it('should handle blog post model - Express', () => {
      const model = new ModelBuilder()
        .name('BlogPost')
        .withIntId()
        .addField(field.string('title'))
        .addField(field.string('slug'))
        .addField(field.string('content'))
        .addField(field.boolean('published', false))
        .addField(field.string('authorId'))
        .addField(field.relation('author', 'User'))
        .withTimestamps()
        .build()

      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()

      expect(output.files.size).toBe(1)
      const content = output.files.get('blogpost.controller.ts')!

      assertValidTypeScript(content)
      assertIncludes(content, [
        'export const listBlogPosts',
        'export const getBlogPost',
        'export const createBlogPost',
        'blogpostService.'
      ])
    })

    it('should handle e-commerce product model - Fastify', () => {
      const model = new ModelBuilder()
        .name('Product')
        .withIntId()
        .addField(field.string('sku'))
        .addField(field.string('name'))
        .addField(field.int('stock'))
        .addField(field.boolean('isActive', true))
        .withTimestamps()
        .build()

      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()

      expect(output.files.size).toBe(1)
      const content = output.files.get('product.controller.ts')!

      assertValidTypeScript(content)
      assertIncludes(content, [
        'export const listProducts',
        'export const getProduct',
        'ProductCreateSchema',
        'productService.'
      ])
    })
  })

  describe('Validation', () => {
    it('should validate model has ID field', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const errors = generator.validate()

      expect(errors).toEqual([])
    })
  })

  describe('Handler Signatures', () => {
    it('should use async arrow functions for Express', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain('= async (req: Request, res: Response)')
    })

    it('should use async arrow functions for Fastify', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain('= async (request: FastifyRequest, reply: FastifyReply)')
    })
  })

  describe('Status Codes', () => {
    it('should use correct status codes - Express', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'status(201)', // create
        'status(204)', // delete
        'status(400)', // validation error
        'status(404)', // not found
        'status(500)'  // server error
      ])
      
      // 200 is implicit via res.json()
      expect(content).toContain('res.json(result)')
    })

    it('should use correct status codes - Fastify', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      assertIncludes(content, [
        'code(201)', // create
        'code(204)', // delete
        'code(400)', // validation error
        'code(404)'  // not found
      ])
    })
  })

  describe('Response Patterns', () => {
    it('should use res.json() for Express success', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain('return res.json(result)')
      expect(content).toContain('return res.json(item)')
    })

    it('should use res.status().json() for Express errors', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'express' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain('res.status(400).json({')
      expect(content).toContain('res.status(404).json({')
      expect(content).toContain('res.status(500).json({')
    })

    it('should return values directly for Fastify success', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain('return result')
      expect(content).toContain('return item')
    })

    it('should use reply.code().send() for Fastify', () => {
      const model = models.todo()
      const generator = new ControllerGenerator({ model, framework: 'fastify' })
      const output = generator.generate()
      const content = output.files.get('todo.controller.ts')!

      expect(content).toContain('reply.code(201).send(item)')
      expect(content).toContain('reply.code(204).send()')
      expect(content).toContain('reply.code(400).send({')
      expect(content).toContain('reply.code(404).send({')
    })
  })
})


