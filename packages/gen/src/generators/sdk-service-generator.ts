/**
 * SDK Service Integration Generator
 * Generates type-safe SDK clients for @service annotated models
 */

import type { ServiceAnnotation } from '../service-linker.js'
import { inferHTTPMethod, inferRoutePath } from '../service-linker.js'
import { kebabToCamelCase } from '../utils/naming.js'

/**
 * Generate SDK client for a service integration
 */
export function generateServiceSDK(annotation: ServiceAnnotation): string {
  const serviceName = kebabToCamelCase(annotation.name)
  const className = `${serviceName.charAt(0).toUpperCase()}${serviceName.slice(1)}Client`
  
  const methods = annotation.methods.map(methodName => {
    return generateServiceMethod(annotation, methodName)
  }).join('\n\n')
  
  return `// @generated
// Service Integration SDK Client for ${annotation.name}

import type { BaseAPIClient, QueryOptions } from '@ssot-codegen/sdk-runtime'

/**
 * ${className}
 * Type-safe client for ${annotation.name} service operations
 */
export class ${className} {
  constructor(private client: BaseAPIClient) {}

${methods}
}
`
}

/**
 * Generate a single service method
 */
function generateServiceMethod(annotation: ServiceAnnotation, methodName: string): string {
  const httpMethod = inferHTTPMethod(methodName)
  const routePath = inferRoutePath(methodName)
  const basePath = `/api/${annotation.name}`
  
  // Determine if method needs data parameter
  const needsData = httpMethod === 'post' || httpMethod === 'put'
  
  const methodCall = needsData
    ? `await this.client.${httpMethod}<any>(
      \`${basePath}${routePath}\`,
      data,
      { signal: options?.signal }
    )`
    : `await this.client.${httpMethod}<any>(
      \`${basePath}${routePath}\`,
      { signal: options?.signal }
    )`
  
  return `  /**
   * ${methodName}
   * ${httpMethod.toUpperCase()} ${basePath}${routePath}
   */
  async ${methodName}(${needsData ? 'data?: any, ' : ''}options?: QueryOptions): Promise<any> {
    const response = ${methodCall}
    return response.data
  }`
}

/**
 * Generate updated main SDK with service clients
 */
export function generateMainSDKWithServices(
  modelClients: Array<{ name: string; className: string }>,
  serviceClients: Array<{ name: string; className: string; annotation: ServiceAnnotation }>
): string {
  const allImports = [
    ...modelClients.map(m => `import { ${m.className} } from './models/${m.name}.client.js'`),
    ...serviceClients.map(s => `import { ${s.className} } from './services/${s.name}.client.js'`)
  ].join('\n')
  
  const allProperties = [
    ...modelClients.map(m => `    ${m.name}: new ${m.className}(client)`),
    ...serviceClients.map(s => `    ${kebabToCamelCase(s.annotation.name)}: new ${s.className}(client)`)
  ].join(',\n')
  
  const allTypes = [
    ...modelClients.map(m => `  ${m.name}: ${m.className}`),
    ...serviceClients.map(s => `  ${kebabToCamelCase(s.annotation.name)}: ${s.className}`)
  ].join('\n')
  
  return `// @generated
// This file is automatically generated. Do not edit manually.

import { BaseAPIClient, createAuthInterceptor, type RequestConfig } from '@ssot-codegen/sdk-runtime'
${allImports}

export interface SDKConfig {
  baseUrl: string
  auth?: {
    token?: string | (() => string | Promise<string>)
    refreshToken?: string | (() => string | Promise<string>)
    onRefresh?: (newToken: string) => void | Promise<void>
    header?: string
    scheme?: string
  }
  timeout?: number
  retries?: number
  headers?: Record<string, string>
  onRequest?: (init: RequestInit) => Promise<RequestInit> | RequestInit
  onResponse?: (response: Response) => Promise<Response> | Response
  onError?: (error: any) => Promise<void> | void
}

/**
 * Create type-safe SDK client
 * 
 * @example
 * \`\`\`typescript
 * const api = createSDK({
 *   baseUrl: 'http://localhost:3000',
 *   auth: { token: () => localStorage.getItem('jwt') }
 * })
 * 
 * // Model clients:
 * const posts = await api.posts.list({ skip: 0, take: 20 })
 * const post = await api.posts.get(123)
 * 
 * // Service clients:
 * await api.aiAgent.sendMessage({ prompt: 'Hello!' })
 * await api.fileStorage.uploadFile(formData)
 * \`\`\`
 */
export function createSDK(config: SDKConfig) {
  // Create base client
  const client = new BaseAPIClient({
    baseUrl: config.baseUrl,
    timeout: config.timeout,
    retries: config.retries,
    headers: config.headers,
    onRequest: config.auth
      ? createAuthInterceptor(config.auth)
      : config.onRequest,
    onResponse: config.onResponse,
    onError: config.onError
  })

  // Return model + service clients
  return {
${allProperties}
  }
}

/**
 * SDK type (for type annotations)
 */
export interface SDK {
${allTypes}
}

// Export for convenience
export type { SDKConfig }
`
}


