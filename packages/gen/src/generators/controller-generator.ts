/**
 * Controller Generator - Generates Express/Fastify controllers
 */

import type { ParsedModel } from '../dmmf-parser.js'
import { toKebabCase, toCamelCase } from '@/utils/naming.js'

export { generateControllerBarrel } from './barrel-generator.js'

/**
 * Generate controller with CRUD operations
 */
export function generateController(model: ParsedModel, framework: 'express' | 'fastify' = 'express'): string {
  const modelKebab = toKebabCase(model.name)  // Use kebab-case for imports
  const modelCamel = toCamelCase(model.name)  // Use camelCase for variable names
  const idType = model.idField?.type === 'String' ? 'string' : 'number'
  const parseId = idType === 'number' 
    ? 'parseInt(req.params.id, 10)'
    : 'req.params.id'
  
  if (framework === 'express') {
    return generateExpressController(model, modelKebab, modelCamel, idType, parseId)
  } else {
    return generateFastifyController(model, modelKebab, modelCamel, idType, parseId)
  }
}

/**
 * Generate Express controller with centralized error handling
 */
function generateExpressController(
  model: ParsedModel,
  modelKebab: string,
  modelCamel: string,
  idType: string,
  parseId: string
): string {
  return `// @generated
// This file is automatically generated. Do not edit manually.

import type { Request, Response } from 'express'
import { ${modelCamel}Service } from '@/services/${modelKebab}'
import { ${model.name}CreateSchema, ${model.name}UpdateSchema, ${model.name}QuerySchema } from '@/validators/${modelKebab}'
import { asyncHandler, ValidationError, NotFoundError } from '@/platform/error'

/**
 * List all ${model.name} records with pagination
 */
export const list${model.name}s = asyncHandler(async (req: Request, res: Response) => {
  // Validate query parameters
  const validation = ${model.name}QuerySchema.safeParse(req.query)
  
  if (!validation.success) {
    throw new ValidationError('Invalid query parameters', validation.error.errors)
  }
  
  const result = await ${modelCamel}Service.list(validation.data)
  res.json(result)
})

/**
 * Get ${model.name} by ID
 */
export const get${model.name} = asyncHandler(async (req: Request, res: Response) => {
  const id = ${parseId}
  ${idType === 'number' ? `
  if (isNaN(id)) {
    throw new ValidationError('Invalid ID format: must be a number')
  }` : ''}
  
  const item = await ${modelCamel}Service.findById(id)
  
  if (!item) {
    throw new NotFoundError('${model.name}', id)
  }
  
  res.json(item)
})

/**
 * Create new ${model.name}
 */
export const create${model.name} = asyncHandler(async (req: Request, res: Response) => {
  // Validate request body
  const validation = ${model.name}CreateSchema.safeParse(req.body)
  
  if (!validation.success) {
    throw new ValidationError('Invalid request body', validation.error.errors)
  }
  
  const item = await ${modelCamel}Service.create(validation.data)
  
  // 201 Created with Location header
  res.status(201)
     .location(\`\${req.baseUrl}/\${item.id}\`)
     .json(item)
})

/**
 * Update ${model.name} by ID
 */
export const update${model.name} = asyncHandler(async (req: Request, res: Response) => {
  const id = ${parseId}
  ${idType === 'number' ? `
  if (isNaN(id)) {
    throw new ValidationError('Invalid ID format: must be a number')
  }` : ''}
  
  // Validate request body
  const validation = ${model.name}UpdateSchema.safeParse(req.body)
  
  if (!validation.success) {
    throw new ValidationError('Invalid request body', validation.error.errors)
  }
  
  const item = await ${modelCamel}Service.update(id, validation.data)
  
  if (!item) {
    throw new NotFoundError('${model.name}', id)
  }
  
  res.json(item)
})

/**
 * Delete ${model.name} by ID
 */
export const delete${model.name} = asyncHandler(async (req: Request, res: Response) => {
  const id = ${parseId}
  ${idType === 'number' ? `
  if (isNaN(id)) {
    throw new ValidationError('Invalid ID format: must be a number')
  }` : ''}
  
  const deleted = await ${modelCamel}Service.delete(id)
  
  if (!deleted) {
    throw new NotFoundError('${model.name}', id)
  }
  
  // 204 No Content - successful deletion
  res.status(204).send()
})

/**
 * Count ${model.name} records
 */
export const count${model.name}s = asyncHandler(async (_req: Request, res: Response) => {
  const total = await ${modelCamel}Service.count()
  res.json({ total })
})
`
}

/**
 * Generate Fastify controller
 */
function generateFastifyController(
  model: ParsedModel,
  modelKebab: string,
  modelCamel: string,
  idType: string,
  parseId: string
): string {
  return `// @generated
// This file is automatically generated. Do not edit manually.

import type { FastifyRequest, FastifyReply } from 'fastify'
import { ${modelCamel}Service } from '@/services/${modelKebab}'
import { ${model.name}CreateSchema, ${model.name}UpdateSchema, ${model.name}QuerySchema } from '@/validators/${modelKebab}'

export const list${model.name}s = async (
  request: FastifyRequest,
  reply: FastifyReply
) => {
  const query = ${model.name}QuerySchema.parse(request.query)
  const result = await ${modelCamel}Service.list(query)
  return result
}

export const get${model.name} = async (
  request: FastifyRequest<{ Params: { id: string } }>,
  reply: FastifyReply
) => {
  const id = ${parseId.replace('req.params', 'request.params')}
  ${idType === 'number' ? `
  if (isNaN(id)) {
    return reply.code(400).send({ error: 'Invalid ID format' })
  }` : ''}
  
  const item = await ${modelCamel}Service.findById(id)
  
  if (!item) {
    return reply.code(404).send({ error: '${model.name} not found' })
  }
  
  return item
}

export const create${model.name} = async (
  request: FastifyRequest,
  reply: FastifyReply
) => {
  const data = ${model.name}CreateSchema.parse(request.body)
  const item = await ${modelCamel}Service.create(data)
  return reply.code(201).send(item)
}

export const update${model.name} = async (
  request: FastifyRequest<{ Params: { id: string } }>,
  reply: FastifyReply
) => {
  const id = ${parseId.replace('req.params', 'request.params')}
  ${idType === 'number' ? `
  if (isNaN(id)) {
    return reply.code(400).send({ error: 'Invalid ID format' })
  }` : ''}
  
  const data = ${model.name}UpdateSchema.parse(request.body)
  const item = await ${modelCamel}Service.update(id, data)
  
  if (!item) {
    return reply.code(404).send({ error: '${model.name} not found' })
  }
  
  return item
}

export const delete${model.name} = async (
  request: FastifyRequest<{ Params: { id: string } }>,
  reply: FastifyReply
) => {
  const id = ${parseId.replace('req.params', 'request.params')}
  ${idType === 'number' ? `
  if (isNaN(id)) {
    return reply.code(400).send({ error: 'Invalid ID format' })
  }` : ''}
  
  const deleted = await ${modelCamel}Service.delete(id)
  
  if (!deleted) {
    return reply.code(404).send({ error: '${model.name} not found' })
  }
  
  return reply.code(204).send()
}
`
}

