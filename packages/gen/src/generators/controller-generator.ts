/**
 * Controller Generator - Generates Express/Fastify controllers
 */

import type { ParsedModel } from '../dmmf-parser.js'

/**
 * Generate controller with CRUD operations
 */
export function generateController(model: ParsedModel, framework: 'express' | 'fastify' = 'express'): string {
  const modelLower = model.nameLower  // Use cached lowercase name
  const idType = model.idField?.type === 'String' ? 'string' : 'number'
  const parseId = idType === 'number' 
    ? 'parseInt(req.params.id, 10)'
    : 'req.params.id'
  
  if (framework === 'express') {
    return generateExpressController(model, modelLower, idType, parseId)
  } else {
    return generateFastifyController(model, modelLower, idType, parseId)
  }
}

/**
 * Generate Express controller
 */
function generateExpressController(
  model: ParsedModel,
  modelLower: string,
  idType: string,
  parseId: string
): string {
  return `// @generated
// This file is automatically generated. Do not edit manually.

import type { Request, Response } from 'express'
import { ${modelLower}Service } from '@/services/${modelLower}'
import { ${model.name}CreateSchema, ${model.name}UpdateSchema, ${model.name}QuerySchema } from '@/validators/${modelLower}'
import { ZodError } from 'zod'

/**
 * List all ${model.name} records
 */
export const list${model.name}s = async (req: Request, res: Response) => {
  try {
    const query = ${model.name}QuerySchema.parse(req.query)
    const result = await ${modelLower}Service.list(query)
    return res.json(result)
  } catch (error) {
    if (error instanceof ZodError) {
      return res.status(400).json({ error: 'Validation Error', details: error.errors })
    }
    console.error(error)
    return res.status(500).json({ error: 'Internal Server Error' })
  }
}

/**
 * Get ${model.name} by ID
 */
export const get${model.name} = async (req: Request, res: Response) => {
  try {
    const id = ${parseId}
    ${idType === 'number' ? `
    if (isNaN(id)) {
      return res.status(400).json({ error: 'Invalid ID format' })
    }` : ''}
    
    const item = await ${modelLower}Service.findById(id)
    
    if (!item) {
      return res.status(404).json({ error: '${model.name} not found' })
    }
    
    return res.json(item)
  } catch (error) {
    console.error(error)
    return res.status(500).json({ error: 'Internal Server Error' })
  }
}

/**
 * Create ${model.name}
 */
export const create${model.name} = async (req: Request, res: Response) => {
  try {
    const data = ${model.name}CreateSchema.parse(req.body)
    const item = await ${modelLower}Service.create(data)
    return res.status(201).json(item)
  } catch (error) {
    if (error instanceof ZodError) {
      return res.status(400).json({ error: 'Validation Error', details: error.errors })
    }
    console.error(error)
    return res.status(500).json({ error: 'Internal Server Error' })
  }
}

/**
 * Update ${model.name}
 */
export const update${model.name} = async (req: Request, res: Response) => {
  try {
    const id = ${parseId}
    ${idType === 'number' ? `
    if (isNaN(id)) {
      return res.status(400).json({ error: 'Invalid ID format' })
    }` : ''}
    
    const data = ${model.name}UpdateSchema.parse(req.body)
    const item = await ${modelLower}Service.update(id, data)
    
    if (!item) {
      return res.status(404).json({ error: '${model.name} not found' })
    }
    
    return res.json(item)
  } catch (error) {
    if (error instanceof ZodError) {
      return res.status(400).json({ error: 'Validation Error', details: error.errors })
    }
    console.error(error)
    return res.status(500).json({ error: 'Internal Server Error' })
  }
}

/**
 * Delete ${model.name}
 */
export const delete${model.name} = async (req: Request, res: Response) => {
  try {
    const id = ${parseId}
    ${idType === 'number' ? `
    if (isNaN(id)) {
      return res.status(400).json({ error: 'Invalid ID format' })
    }` : ''}
    
    const deleted = await ${modelLower}Service.delete(id)
    
    if (!deleted) {
      return res.status(404).json({ error: '${model.name} not found' })
    }
    
    return res.status(204).send()
  } catch (error) {
    console.error(error)
    return res.status(500).json({ error: 'Internal Server Error' })
  }
}

/**
 * Count ${model.name} records
 */
export const count${model.name}s = async (_req: Request, res: Response) => {
  try {
    const total = await ${modelLower}Service.count()
    return res.json({ total })
  } catch (error) {
    console.error(error)
    return res.status(500).json({ error: 'Internal Server Error' })
  }
}
`
}

/**
 * Generate Fastify controller
 */
function generateFastifyController(
  model: ParsedModel,
  modelLower: string,
  idType: string,
  parseId: string
): string {
  return `// @generated
// This file is automatically generated. Do not edit manually.

import type { FastifyRequest, FastifyReply } from 'fastify'
import { ${modelLower}Service } from '@/services/${modelLower}'
import { ${model.name}CreateSchema, ${model.name}UpdateSchema, ${model.name}QuerySchema } from '@/validators/${modelLower}'

export const list${model.name}s = async (
  request: FastifyRequest,
  reply: FastifyReply
) => {
  const query = ${model.name}QuerySchema.parse(request.query)
  const result = await ${modelLower}Service.list(query)
  return result
}

export const get${model.name} = async (
  request: FastifyRequest<{ Params: { id: string } }>,
  reply: FastifyReply
) => {
  const id = ${parseId.replace('req.params', 'request.params')}
  ${idType === 'number' ? `
  if (isNaN(id)) {
    return reply.code(400).send({ error: 'Invalid ID format' })
  }` : ''}
  
  const item = await ${modelLower}Service.findById(id)
  
  if (!item) {
    return reply.code(404).send({ error: '${model.name} not found' })
  }
  
  return item
}

export const create${model.name} = async (
  request: FastifyRequest,
  reply: FastifyReply
) => {
  const data = ${model.name}CreateSchema.parse(request.body)
  const item = await ${modelLower}Service.create(data)
  return reply.code(201).send(item)
}

export const update${model.name} = async (
  request: FastifyRequest<{ Params: { id: string } }>,
  reply: FastifyReply
) => {
  const id = ${parseId.replace('req.params', 'request.params')}
  ${idType === 'number' ? `
  if (isNaN(id)) {
    return reply.code(400).send({ error: 'Invalid ID format' })
  }` : ''}
  
  const data = ${model.name}UpdateSchema.parse(request.body)
  const item = await ${modelLower}Service.update(id, data)
  
  if (!item) {
    return reply.code(404).send({ error: '${model.name} not found' })
  }
  
  return item
}

export const delete${model.name} = async (
  request: FastifyRequest<{ Params: { id: string } }>,
  reply: FastifyReply
) => {
  const id = ${parseId.replace('req.params', 'request.params')}
  ${idType === 'number' ? `
  if (isNaN(id)) {
    return reply.code(400).send({ error: 'Invalid ID format' })
  }` : ''}
  
  const deleted = await ${modelLower}Service.delete(id)
  
  if (!deleted) {
    return reply.code(404).send({ error: '${model.name} not found' })
  }
  
  return reply.code(204).send()
}
`
}

/**
 * Generate barrel export for controller
 */
export function generateControllerBarrel(model: ParsedModel): string {
  return `// @generated barrel
export * from './${model.nameLower}.controller.js'
`
}


