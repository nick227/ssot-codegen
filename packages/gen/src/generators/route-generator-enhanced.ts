/**
 * Enhanced Route Generator - Generates routes with domain-specific endpoints
 */

import type { ParsedModel, ParsedSchema } from '../dmmf-parser.js'
import type { ModelAnalysis } from '../utils/relationship-analyzer.js'
import { toCamelCase, toKebabCase } from '../utils/naming.js'

/**
 * Generate enhanced routes with domain methods
 * Returns null if this model should not have routes generated (e.g., junction tables)
 * OPTIMIZED: Accepts pre-computed analysis from cache
 */
export function generateEnhancedRoutes(
  model: ParsedModel,
  schema: ParsedSchema,
  framework: 'express' | 'fastify' = 'express',
  analysis: ModelAnalysis  // â­ Accept cached analysis
): string | null {
  // Remove: const analysis = analyzeModel(model, schema)
  
  // Skip junction tables
  if (analysis.isJunctionTable) {
    return null
  }
  
  const modelKebab = toKebabCase(model.name)  // Use kebab-case for folder paths
  const modelCamel = toCamelCase(model.name)
  
  if (framework === 'express') {
    return generateExpressRoutes(model, analysis, modelKebab, modelCamel)
  } else {
    return generateFastifyRoutes(model, analysis, modelKebab, modelCamel)
  }
}

/**
 * Generate Express routes with enhanced endpoints
 */
function generateExpressRoutes(
  model: ParsedModel,
  analysis: ModelAnalysis,
  modelKebab: string,
  modelCamel: string
): string {
  const baseRoutes = generateExpressBaseRoutes(model, modelCamel)
  const domainRoutes = generateExpressDomainRoutes(model, analysis, modelCamel)
  
  return `// @generated
// This file is automatically generated. Do not edit manually.

import { Router, type Router as RouterType } from 'express'
import * as ${modelCamel}Controller from '@/controllers/${modelKebab}/index.js'

export const ${modelCamel}Router: RouterType = Router()

${baseRoutes}${domainRoutes}
`
}

/**
 * Generate base CRUD routes (including bulk operations)
 */
function generateExpressBaseRoutes(model: ParsedModel, modelCamel: string): string {
  return `// List all ${model.name} records (simple pagination)
${modelCamel}Router.get('/', ${modelCamel}Controller.list${model.name}s)

// Search ${model.name} records (complex filtering via POST body)
${modelCamel}Router.post('/search', ${modelCamel}Controller.search${model.name}s)

// Get ${model.name} by ID
${modelCamel}Router.get('/:id', ${modelCamel}Controller.get${model.name})

// Create ${model.name}
${modelCamel}Router.post('/', ${modelCamel}Controller.create${model.name})

// Update ${model.name}
${modelCamel}Router.put('/:id', ${modelCamel}Controller.update${model.name})
${modelCamel}Router.patch('/:id', ${modelCamel}Controller.update${model.name})

// Delete ${model.name}
${modelCamel}Router.delete('/:id', ${modelCamel}Controller.delete${model.name})

// Count ${model.name} records
${modelCamel}Router.get('/meta/count', ${modelCamel}Controller.count${model.name}s)

// Bulk operations
${modelCamel}Router.post('/bulk/create', ${modelCamel}Controller.bulkCreate${model.name}s)
${modelCamel}Router.put('/bulk/update', ${modelCamel}Controller.bulkUpdate${model.name}s)
${modelCamel}Router.delete('/bulk/delete', ${modelCamel}Controller.bulkDelete${model.name}s)
`
}

/**
 * Generate domain-specific routes
 */
function generateExpressDomainRoutes(
  model: ParsedModel,
  analysis: ModelAnalysis,
  modelCamel: string
): string {
  const routes: string[] = []
  
  // Slug lookup route (must come before /:id to avoid conflicts)
  if (analysis.hasSlugField) {
    routes.push(`// Get ${model.name} by slug
${modelCamel}Router.get('/slug/:slug', ${modelCamel}Controller.get${model.name}BySlug)
`)
  }
  
  // Published filtering
  if (analysis.hasPublishedField) {
    routes.push(`// List published ${model.name} records
${modelCamel}Router.get('/published', ${modelCamel}Controller.listPublished${model.name}s)

// Publish/unpublish ${model.name}
${modelCamel}Router.post('/:id/publish', ${modelCamel}Controller.publish${model.name})
${modelCamel}Router.post('/:id/unpublish', ${modelCamel}Controller.unpublish${model.name})
`)
  }
  
  // View counter
  if (analysis.specialFields.views) {
    routes.push(`// Increment ${model.name} views
${modelCamel}Router.post('/:id/views', ${modelCamel}Controller.increment${model.name}Views)
`)
  }
  
  // Approval workflow
  if (analysis.specialFields.approved) {
    routes.push(`// List pending ${model.name} records
${modelCamel}Router.get('/pending', ${modelCamel}Controller.listPending${model.name}s)

// Approve ${model.name}
${modelCamel}Router.post('/:id/approve', ${modelCamel}Controller.approve${model.name})
`)
  }
  
  return routes.length > 0 ? '\n' + routes.join('\n') : ''
}

/**
 * Generate Fastify routes (similar pattern)
 */
function generateFastifyRoutes(
  model: ParsedModel,
  analysis: ModelAnalysis,
  modelKebab: string,
  modelCamel: string
): string {
  return `// @generated
// Fastify routes - TBD
import type { FastifyInstance } from 'fastify'
import * as ${modelCamel}Controller from '@/controllers/${modelKebab}'

export async function ${modelCamel}Routes(fastify: FastifyInstance) {
  // TODO: Generate Fastify routes
}
`
}

/**
 * Determine if a model should have routes generated
 */
export function shouldGenerateRoutes(model: ParsedModel, schema: ParsedSchema, analysis: ModelAnalysis): boolean {
  return !analysis.isJunctionTable
}


