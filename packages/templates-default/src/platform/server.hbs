/**
 * Express Server Setup
 * 
 * Production-ready Express application with:
 * - Security middleware (Helmet, CORS, rate limiting)
 * - Structured logging with request IDs
 * - Health check endpoints
 * - API versioning
 * - Centralized error handling
 * - Graceful shutdown
 */

import express, { Express, Request, Response } from 'express';
import { config, isProduction } from './platform/config.js';
import { logger, httpLogger } from './platform/logger.js';
import { errorHandler } from './platform/error.js';
import {
  securityHeaders,
  corsMiddleware,
  rateLimiter,
  parameterPollutionProtection,
  configureTrustProxy,
} from './platform/security.js';
import {
  livenessCheck,
  readinessCheck,
  registerShutdownHandlers,
} from './platform/health.js';

{{#if swaggerEnabled}}
import swaggerUi from 'swagger-ui-express';
import openApiSpec from './openapi.json' assert { type: 'json' };
{{/if}}

// Import route registries
{{#each models}}
import { {{camelCase name}}Router } from './routes/{{kebabCase name}}.routes.js';
{{/each}}

/**
 * Create and configure Express application
 */
export function createApp(): Express {
  const app = express();
  
  // Trust proxy
  configureTrustProxy(app);
  
  // Security middleware (apply early)
  app.use(securityHeaders);
  app.use(corsMiddleware);
  app.use(rateLimiter);
  
  // Body parsing middleware
  app.use(express.json({ limit: '2mb' }));
  app.use(express.urlencoded({ extended: true, limit: '2mb' }));
  
  // Parameter pollution protection
  app.use(parameterPollutionProtection);
  
  // Request logging (after security, before routes)
  app.use(httpLogger);
  
  // Health check endpoints (no auth, outside API prefix)
  app.get('/health', livenessCheck);
  app.get('/health/ready', readinessCheck);
  
  {{#if swaggerEnabled}}
  // Swagger UI (gated by config)
  if (config.SWAGGER_ENABLED) {
    app.use(
      '/docs',
      swaggerUi.serve,
      swaggerUi.setup(openApiSpec, {
        customSiteTitle: '{{projectName}} API Documentation',
        customCss: '.swagger-ui .topbar { display: none }',
      })
    );
    logger.info(`ðŸ“š Swagger UI available at http://${config.HOST}:${config.PORT}/docs`);
  }
  {{/if}}
  
  // API routes (versioned)
  const apiRouter = express.Router();
  
  {{#each models}}
  apiRouter.use('/{{kebabCase (pluralize name)}}', {{camelCase name}}Router);
  {{/each}}
  
  // Mount API router with version prefix
  app.use(`${config.API_PREFIX}/${config.API_VERSION}`, apiRouter);
  
  // 404 handler for unknown routes
  app.use((req: Request, res: Response) => {
    res.status(404).json({
      type: '/errors/not-found',
      title: 'Not Found',
      status: 404,
      detail: `Route ${req.method} ${req.url} not found`,
      instance: req.url,
    });
  });
  
  // Global error handler (must be last)
  app.use(errorHandler);
  
  return app;
}

/**
 * Start the server
 */
export async function startServer(): Promise<void> {
  const app = createApp();
  
  // Register graceful shutdown handlers
  registerShutdownHandlers();
  
  // Start listening
  const server = app.listen(config.PORT, config.HOST, () => {
    logger.info({
      environment: config.NODE_ENV,
      port: config.PORT,
      host: config.HOST,
      apiVersion: config.API_VERSION,
    }, `ðŸš€ Server started`);
    
    logger.info(`ðŸ“ API: http://${config.HOST}:${config.PORT}${config.API_PREFIX}/${config.API_VERSION}`);
    logger.info(`â¤ï¸  Health: http://${config.HOST}:${config.PORT}/health`);
  });
  
  // Handle server errors
  server.on('error', (error: NodeJS.ErrnoException) => {
    if (error.code === 'EADDRINUSE') {
      logger.error(`Port ${config.PORT} is already in use`);
    } else {
      logger.error({ err: error }, 'Server error');
    }
    process.exit(1);
  });
}

// Start server if this is the main module
if (import.meta.url === `file://${process.argv[1]}`) {
  startServer().catch((error) => {
    logger.error({ err: error }, 'Failed to start server');
    process.exit(1);
  });
}

