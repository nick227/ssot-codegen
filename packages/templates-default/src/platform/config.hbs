/**
 * Configuration Module
 * 
 * Loads and validates environment variables with type-safe configuration
 * using Zod for runtime validation.
 */

import { z } from 'zod';
import dotenv from 'dotenv';
import path from 'path';

// Load environment variables
const envFile = process.env.NODE_ENV === 'test' 
  ? '.env.test' 
  : process.env.NODE_ENV === 'production' 
    ? '.env' 
    : '.env.development';

dotenv.config({ path: path.resolve(process.cwd(), envFile) });

// Configuration schema with Zod validation
const configSchema = z.object({
  // Server
  NODE_ENV: z.enum(['development', 'test', 'production']).default('development'),
  PORT: z.coerce.number().int().positive().default(3000),
  HOST: z.string().default('localhost'),
  
  // API
  API_VERSION: z.string().default('v1'),
  API_PREFIX: z.string().default('/api'),
  
  // Database (supports PostgreSQL, MySQL, SQLite file URLs)
  DATABASE_URL: z.string().min(1, 'DATABASE_URL is required'),
  
  // Security
  CORS_ORIGIN: z.string().default('*'),
  RATE_LIMIT_WINDOW_MS: z.coerce.number().default(15 * 60 * 1000), // 15 minutes
  RATE_LIMIT_MAX_REQUESTS: z.coerce.number().default(100),
  
  // Logging
  LOG_LEVEL: z.enum(['trace', 'debug', 'info', 'warn', 'error', 'fatal']).default('info'),
  LOG_PRETTY: z.coerce.boolean().default(false),
  
  // Features
  SWAGGER_ENABLED: z.coerce.boolean().default(false), // Disabled in production by default
  METRICS_ENABLED: z.coerce.boolean().default(false),
  
  // Pagination
  DEFAULT_PAGE_SIZE: z.coerce.number().int().positive().default(20),
  MAX_PAGE_SIZE: z.coerce.number().int().positive().default(100),
});

// Parse and validate configuration
function loadConfig() {
  const result = configSchema.safeParse(process.env);
  
  if (!result.success) {
    console.error('âŒ Invalid configuration:');
    result.error.issues.forEach((issue) => {
      console.error(`  - ${issue.path.join('.')}: ${issue.message}`);
    });
    process.exit(1);
  }
  
  return result.data;
}

// Export typed configuration
export const config = loadConfig();
export type Config = z.infer<typeof configSchema>;

// Environment helpers
export const isDevelopment = config.NODE_ENV === 'development';
export const isProduction = config.NODE_ENV === 'production';
export const isTest = config.NODE_ENV === 'test';

// API URL helpers
export const getApiUrl = (path: string = '') => {
  const base = `http://${config.HOST}:${config.PORT}${config.API_PREFIX}/${config.API_VERSION}`;
  return path ? `${base}${path.startsWith('/') ? '' : '/'}${path}` : base;
};

