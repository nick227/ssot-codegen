name: CI

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]

jobs:
  quality:
    name: Code Quality & Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm build
      
      - name: Type check
        run: pnpm typecheck
      
      - name: Lint
        run: pnpm lint
      
      - name: Check for circular dependencies
        run: pnpm madge
      
      - name: Check for unused exports
        run: pnpm knip
      
      - name: Run generator tests
        run: pnpm test:generator
      
      - name: Test minimal example generation
        run: pnpm ssot generate minimal
      
      - name: Validate generated project
        run: |
          cd generated/minimal-1
          pnpm install
          pnpm typecheck

  plugin-tests:
    name: Plugin Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm build
      
      - name: Test AI plugins
        run: cd packages/gen && pnpm test src/plugins/__tests__/ai-plugins.test.ts
      
      - name: Test storage plugins
        run: cd packages/gen && pnpm test src/plugins/__tests__/storage-plugins.test.ts
      
      - name: Test payment/email plugins
        run: cd packages/gen && pnpm test src/plugins/__tests__/payment-email-plugins.test.ts

  generation-tests:
    name: Example Generation Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        example: [minimal, blog-example, ai-chat-example]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm build
      
      - name: Generate ${{ matrix.example }}
        run: pnpm ssot generate ${{ matrix.example }}
      
      - name: Find generated directory
        id: find-dir
        run: |
          DIR=$(ls -td generated/${{ matrix.example }}-* | head -1)
          echo "dir=$DIR" >> $GITHUB_OUTPUT
      
      - name: Install generated project
        run: |
          cd ${{ steps.find-dir.outputs.dir }}
          pnpm install
      
      - name: Type check generated project
        run: |
          cd ${{ steps.find-dir.outputs.dir }}
          pnpm typecheck
      
      - name: Test generated project (if has tests)
        run: |
          cd ${{ steps.find-dir.outputs.dir }}
          if [ -f "tests/self-validation.test.ts" ]; then
            echo "DATABASE_URL=file:./test.db" > .env
            pnpm test:validate || true
          fi

  publish-check:
    name: Publish Readiness
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm build
      
      - name: Check package versions in sync
        run: |
          ROOT_VERSION=$(node -p "require('./package.json').version")
          CLI_VERSION=$(node -p "require('./packages/cli/package.json').version")
          GEN_VERSION=$(node -p "require('./packages/gen/package.json').version")
          
          if [ "$ROOT_VERSION" != "$CLI_VERSION" ] || [ "$ROOT_VERSION" != "$GEN_VERSION" ]; then
            echo "❌ Version mismatch!"
            echo "Root: $ROOT_VERSION"
            echo "CLI: $CLI_VERSION"
            echo "Gen: $GEN_VERSION"
            exit 1
          fi
          
          echo "✅ All versions in sync: $ROOT_VERSION"
      
      - name: Verify no lint errors
        run: pnpm lint
      
      - name: Verify all tests pass
        run: pnpm test:generator
      
      - name: Check bundle size
        run: |
          du -sh packages/*/dist/
          echo "✅ Build artifacts ready"

