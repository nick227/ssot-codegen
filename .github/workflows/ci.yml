name: CI

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]

jobs:
  # Job 1: Code Quality & Basic Tests
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm build
      
      - name: Type check
        run: pnpm typecheck
      
      - name: Lint
        run: pnpm lint
      
      - name: Check circular dependencies
        run: pnpm madge
      
      - name: Check unused exports
        run: pnpm knip || true  # Allow knip to warn but not fail
      
      - name: Run generator tests
        run: pnpm test:generator

  # Job 2: Smoke Test - Quick generation test
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: quality
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm build
      
      - name: Run smoke test
        run: |
          echo "Running smoke test - generate minimal example"
          pnpm ssot generate minimal --name smoke-test
          
          echo "Verify output directory exists"
          ls -la generated/
          
          echo "Verify key files were generated"
          test -f generated/smoke-test-1/package.json
          test -d generated/smoke-test-1/src
          test -f generated/smoke-test-1/src/app.ts
          test -f generated/smoke-test-1/src/server.ts
          
          echo "Install dependencies in generated project"
          cd generated/smoke-test-1
          pnpm install
          
          echo "Build generated project"
          pnpm build
          
          echo "✅ Smoke test passed!"

  # Job 3: Example Generation Tests (Matrix)
  examples:
    name: Test ${{ matrix.example }}
    runs-on: ubuntu-latest
    needs: smoke-test
    
    strategy:
      fail-fast: false
      matrix:
        example: [minimal, blog-example, ecommerce-example]
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm build
      
      - name: Generate ${{ matrix.example }}
        run: pnpm ssot generate ${{ matrix.example }}
      
      - name: Find generated directory
        id: find_dir
        run: |
          DIR=$(ls -td generated/${{ matrix.example }}-* | head -1)
          echo "dir=$DIR" >> $GITHUB_OUTPUT
          echo "Found: $DIR"
      
      - name: Install generated project dependencies
        working-directory: ${{ steps.find_dir.outputs.dir }}
        run: pnpm install
      
      - name: Build generated project
        working-directory: ${{ steps.find_dir.outputs.dir }}
        run: pnpm build
      
      - name: Run self-validation tests
        working-directory: ${{ steps.find_dir.outputs.dir }}
        run: pnpm test:validate || echo "Validation tests not available"

  # Job 4: Multi-platform smoke test
  cross-platform:
    name: Cross-platform (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: quality
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm build
      
      - name: Generate minimal example
        run: pnpm ssot generate minimal
      
      - name: Verify generation (Unix)
        if: runner.os != 'Windows'
        run: |
          test -f generated/minimal-1/package.json
          echo "✅ Generation successful on ${{ matrix.os }}"
      
      - name: Verify generation (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Test-Path generated/minimal-1/package.json) {
            Write-Host "✅ Generation successful on ${{ matrix.os }}"
          } else {
            Write-Error "❌ Generation failed"
            exit 1
          }
