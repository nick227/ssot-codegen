# SSOT Codegen Technical Notes

## v0.4.0 - POC Complete (November 2025)

### What Works
1. **Monorepo Structure**
   - pnpm workspaces with 5 packages
   - TypeScript 5.4+ compilation
   - Proper workspace protocol dependencies

2. **Generator Core**
   - DMMF normalization (stubbed for POC)
   - Per-model artifact generation
   - Layer-first directory structure
   - POSIX-style paths throughout

3. **Path Resolution**
   - `@gen` alias for clean imports
   - tsconfig.paths.json emission
   - Barrel files at layer and model levels
   - Layer-aware barrel exports (each layer exports its own files)

4. **Manifest System**
   - schemaHash tracking (SHA-256)
   - toolVersion metadata
   - Complete pathMap with fs → esm mapping
   - ISO timestamp for each build

5. **OpenAPI Generation**
   - OpenAPI 3.1.0 spec
   - Paths for each model
   - Component schemas (ReadDTO per model)

6. **Validation**
   - TypeScript compilation passes
   - Deterministic output (except timestamps)
   - No deep relative imports (`../../../`)
   - All packages have proper exports

### Known Limitations (POC)

1. **DMMF** - Currently uses stubbed data, not real `@prisma/generator-helper`
2. **Templates** - Hardcoded generation, Handlebars integration pending
3. **Field Types** - All fields stubbed, not reading actual Prisma field metadata
4. **Relations** - Not analyzing model relationships
5. **Schema Tags** - No `@route`, `@auth`, `@expose` parsing yet
6. **Validators** - Zod files are stubs, no actual schema validation
7. **Auth** - Policy files empty
8. **Tests** - No test generation yet
9. **Performance** - No hash-based skip writes or parallel generation

### Architecture Decisions

#### Path Strategy
- **Alias-first**: All cross-layer imports use `@gen/*`
- **Barrels**: Each model folder has index.ts exporting its files
- **POSIX**: Forward slashes everywhere, even on Windows
- **ESM**: .js extensions in import paths for ESM compatibility

#### File Naming
- Pattern: `{model}.{artifact}.{suffix}.ts`
- Example: `user.create.dto.ts`
- Lowercase model names in paths
- PascalCase model names in code

#### Barrel Strategy
- **Model barrels**: Export all files in that model folder using relative paths
- **Layer barrels**: Export model barrels using alias paths
- Generated by `emitBarrels()` after all model files created
- Tracked in manifest pathMap

#### Manifest Design
```json
{
  "schemaHash": "sha256 of input",
  "toolVersion": "0.4.0",
  "generated": "ISO timestamp",
  "outputs": [{
    "id": "layer:Model:file",
    "fs": "filesystem path",
    "esm": "import path"
  }],
  "pathMap": { /* same structure */ }
}
```

### Complexity & Risk Assessment

**Low Complexity:**
- Path resolver ✅
- File writing ✅
- Barrel generation ✅

**Medium Complexity:**
- Template engine integration
- DMMF parsing
- Field type mapping

**High Complexity:**
- Auth policy compilation
- Zod schema generation with full type parity
- Client SDK generation
- Schema tag parsing with validation

**Performance Concerns:**
- Large schemas (100+ models) - need batched I/O
- Unchanged layer detection - need hash-based skipping
- Template compilation - cache compiled templates

### Milestones

**Milestone 1: Foundation** ✅ (v0.4.0)
- [x] Monorepo setup
- [x] Basic generator
- [x] Path resolver
- [x] Manifest system
- [x] OpenAPI stub

**Milestone 2: Real DMMF** (v0.5.0)
- [ ] Integrate `@prisma/generator-helper`
- [ ] Parse actual field types
- [ ] Handle relations
- [ ] Support enums
- [ ] Parse schema comments

**Milestone 3: Templates** (v0.6.0)
- [ ] Handlebars integration
- [ ] Template partials
- [ ] Helper functions
- [ ] Template validation

**Milestone 4: Validators** (v0.7.0)
- [ ] Zod schema generation
- [ ] Optional vs nullable semantics
- [ ] PATCH shapes
- [ ] Custom error messages

**Milestone 5: Auth** (v0.8.0)
- [ ] Policy DSL design
- [ ] Compile to Prisma where filters
- [ ] Field-level masking
- [ ] Role hierarchies

**Milestone 6: SDK** (v0.9.0)
- [ ] Generate typed client from OpenAPI
- [ ] React Query hooks (optional)
- [ ] ETag support
- [ ] Idempotency keys

**Milestone 7: Performance** (v1.0.0)
- [ ] Hash-based skip writes
- [ ] Parallel per-model generation
- [ ] Batched filesystem I/O
- [ ] Template caching
- [ ] Unchanged layer short-circuit

### Testing Strategy

**Current:**
- TypeScript compilation test
- OpenAPI structure validation
- Determinism check (timestamps expected to differ)
- Manual consumer import test

**Needed:**
- Unit tests for path resolver
- Unit tests for normalization
- Integration test suite
- Template rendering tests
- Schema linting tests
- Performance benchmarks

### CI/CD Plan

```yaml
# Proposed GitHub Actions workflow
on: [push, pull_request]
jobs:
  test:
    - pnpm install
    - pnpm run build
    - pnpm run generate-example
    - node scripts/validate-openapi.js
    - Verify manifest schemaHash
    - Run determinism check
    - Check for deep relative imports
  publish:
    - if: tag v*
    - build packages
    - pnpm publish (dry-run for POC)
```

### External Consumption

```bash
# As a library
npm install @ssot-codegen/gen @ssot-codegen/templates-default

# In prisma/schema.prisma
generator ssot {
  provider = "@ssot-codegen/gen"
  output   = "../src/generated"
}

# Then
npx prisma generate
```

### Tech Debt

1. **Duplicate folders**: `/core`, `/gen` etc. at root should be removed (only `/packages` needed)
2. **Template stubs**: Handlebars files exist but not used
3. **Error handling**: Minimal error reporting
4. **Logging**: Basic console.log, need structured logging
5. **Config validation**: No schema validation for generator config
6. **Path normalization**: Could use `node:path` more consistently

### Performance Targets (Future)

- **Small schema** (5 models): < 100ms
- **Medium schema** (50 models): < 1s
- **Large schema** (200 models): < 5s
- **Unchanged regeneration**: < 50ms (with hashing)

### Security Considerations

1. **Schema hash**: Prevents accidental regeneration with wrong schema
2. **Type safety**: Generated imports use `import type` where possible
3. **No eval**: No dynamic code execution in generator
4. **Path traversal**: All paths normalized to prevent `../` attacks
5. **Auth policies**: Future compiler must validate policy syntax

### Contributors Guide

**Adding a new layer:**
1. Add to `defaultPaths.layers` in `packages/gen/src/index.ts`
2. Create rendering function in `renderModel()`
3. Add `trackFile()` call for barrel generation
4. Update OpenAPI if applicable

**Never edit `/gen` outputs:**
- All customization via `/src/extensions/*.ext.ts` (future hooks)
- Generated files have `// @generated` markers

### Version History

- **v0.3.0**: Initial POC structure
- **v0.4.0**: Path resolver, barrels, manifest, verified compilation ✅\n