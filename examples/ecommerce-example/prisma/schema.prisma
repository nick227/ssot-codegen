// E-commerce Example: IMPROVED VERSION
// Production-ready schema with critical e-commerce features
// Includes: Coupons, Stock Reservation, Refunds, Enhanced Cart, SEO

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Customer/User model with authentication
/// @route /customers
/// @auth required
model Customer {
  id              Int       @id @default(autoincrement())
  email           String    @unique
  firstName       String
  lastName        String
  phone           String?
  
  // Authentication
  passwordHash    String
  emailVerified   Boolean   @default(false)
  emailVerifyToken String?
  lastLoginAt     DateTime?
  
  // Status
  isActive        Boolean   @default(true)
  
  // Preferences
  marketingOptIn  Boolean   @default(false)
  language        String    @default("en")
  currency        String    @default("USD")
  
  // Loyalty
  loyaltyPoints   Int       @default(0)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  addresses       Address[]
  orders          Order[]
  cart            Cart?
  reviews         Review[]
  wishlist        WishlistItem[]
  productAlerts   ProductAlert[]
  
  @@index([email])
  @@index([isActive])
}

/// Physical/Billing address
/// @route /addresses
/// @auth required
model Address {
  id              Int       @id @default(autoincrement())
  customerId      Int
  addressType     AddressType
  streetAddress   String
  addressLine2    String?
  city            String
  state           String
  postalCode      String
  country         String    @default("US")
  phone           String?
  isDefault       Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  customer        Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  shippingOrders  Order[]   @relation("ShippingAddress")
  billingOrders   Order[]   @relation("BillingAddress")
  
  @@index([customerId])
}

/// Product catalog with SEO
/// @route /products
/// @auth optional
model Product {
  id              Int       @id @default(autoincrement())
  sku             String    @unique
  name            String
  slug            String    @unique
  description     String
  shortDescription String?
  
  // Pricing
  price           Decimal   @db.Decimal(10, 2)
  compareAtPrice  Decimal?  @db.Decimal(10, 2)
  costPrice       Decimal?  @db.Decimal(10, 2)
  
  // Inventory
  stock           Int       @default(0)
  lowStockThreshold Int     @default(10)
  reservedStock   Int       @default(0)
  
  // Physical attributes
  weight          Decimal?  @db.Decimal(8, 2)
  length          Decimal?  @db.Decimal(8, 2)
  width           Decimal?  @db.Decimal(8, 2)
  height          Decimal?  @db.Decimal(8, 2)
  
  // SEO
  metaTitle       String?   @db.VarChar(60)
  metaDescription String?   @db.VarChar(160)
  metaKeywords    String?
  
  // Configuration
  condition       ProductCondition @default(NEW)
  minOrderQty     Int       @default(1)
  maxOrderQty     Int?
  
  // Status
  isActive        Boolean   @default(true)
  isFeatured      Boolean   @default(false)
  
  // Availability
  availableFrom   DateTime?
  availableUntil  DateTime?
  
  // Relationships
  categoryId      Int
  brandId         Int?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  category        Category  @relation(fields: [categoryId], references: [id])
  brand           Brand?    @relation(fields: [brandId], references: [id])
  images          ProductImage[]
  variants        ProductVariant[]
  orderItems      OrderItem[]
  cartItems       CartItem[]
  reviews         Review[]
  tags            ProductTag[]
  wishlistItems   WishlistItem[]
  stockReservations StockReservation[]
  stockHistory    StockHistory[]
  productAlerts   ProductAlert[]
  
  @@index([slug])
  @@index([categoryId])
  @@index([sku])
  @@index([isActive, isFeatured, createdAt])
  @@index([categoryId, isActive])
}

/// Product categories with hierarchy
/// @route /categories
/// @auth optional
model Category {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  slug            String    @unique
  description     String?
  imageUrl        String?
  parentId        Int?
  displayOrder    Int       @default(0)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  parent          Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        Category[] @relation("CategoryHierarchy")
  products        Product[]
  
  @@index([slug])
  @@index([parentId])
}

/// Product brands
/// @route /brands
/// @auth optional
model Brand {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  slug            String    @unique
  description     String?
  logoUrl         String?
  websiteUrl      String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  
  products        Product[]
  
  @@index([slug])
}

/// Product images
model ProductImage {
  id              Int       @id @default(autoincrement())
  productId       Int
  imageUrl        String
  altText         String?
  displayOrder    Int       @default(0)
  isPrimary       Boolean   @default(false)
  createdAt       DateTime  @default(now())
  
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([productId])
}

/// Product variants (size, color, etc.)
model ProductVariant {
  id              Int       @id @default(autoincrement())
  productId       Int
  sku             String    @unique
  name            String
  priceAdjustment Decimal   @default(0) @db.Decimal(10, 2)
  stock           Int       @default(0)
  reservedStock   Int       @default(0)
  attributes      Json      // { "size": "L", "color": "Red" }
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems       CartItem[]
  stockReservations StockReservation[]
  
  @@index([productId])
  @@index([sku])
}

/// Shopping cart with expiry
/// @route /cart
/// @auth required
model Cart {
  id              Int       @id @default(autoincrement())
  customerId      Int       @unique
  expiresAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  customer        Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items           CartItem[]
  reservations    StockReservation[]
}

/// Cart items with variant and price snapshot
model CartItem {
  id              Int       @id @default(autoincrement())
  cartId          Int
  productId       Int
  variantId       Int?
  quantity        Int       @default(1)
  unitPrice       Decimal   @db.Decimal(10, 2)
  addedAt         DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  cart            Cart      @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product         Product   @relation(fields: [productId], references: [id])
  variant         ProductVariant? @relation(fields: [variantId], references: [id])
  
  @@unique([cartId, productId, variantId])
  @@index([cartId])
}

/// Stock reservation during checkout
model StockReservation {
  id              Int       @id @default(autoincrement())
  productId       Int
  variantId       Int?
  quantity        Int
  cartId          Int?
  orderId         Int?
  expiresAt       DateTime
  createdAt       DateTime  @default(now())
  
  product         Product   @relation(fields: [productId], references: [id])
  variant         ProductVariant? @relation(fields: [variantId], references: [id])
  cart            Cart?     @relation(fields: [cartId], references: [id])
  order           Order?    @relation(fields: [orderId], references: [id])
  
  @@index([productId])
  @@index([expiresAt])
}

/// Track stock changes for audit
model StockHistory {
  id              Int       @id @default(autoincrement())
  productId       Int
  change          Int
  reason          StockChangeReason
  orderId         Int?
  notes           String?
  createdAt       DateTime  @default(now())
  createdBy       Int?
  
  product         Product   @relation(fields: [productId], references: [id])
  
  @@index([productId, createdAt])
}

/// Customer orders with detailed tracking
/// @route /orders
/// @auth required
model Order {
  id              Int       @id @default(autoincrement())
  orderNumber     String    @unique
  customerId      Int
  status          OrderStatus @default(PENDING)
  
  // Pricing
  subtotal        Decimal   @db.Decimal(10, 2)
  tax             Decimal   @db.Decimal(10, 2)
  shipping        Decimal   @db.Decimal(10, 2)
  discount        Decimal   @default(0) @db.Decimal(10, 2)
  total           Decimal   @db.Decimal(10, 2)
  
  // Addresses
  shippingAddressId Int
  billingAddressId  Int?
  
  // Coupon
  couponId        Int?
  couponCode      String?
  
  // Tracking
  notes           String?
  ipAddress       String?
  estimatedDelivery DateTime?
  
  // Status timestamps
  confirmedAt     DateTime?
  packedAt        DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  cancelledAt     DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  customer        Customer  @relation(fields: [customerId], references: [id])
  shippingAddress Address   @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress  Address?  @relation("BillingAddress", fields: [billingAddressId], references: [id])
  coupon          Coupon?   @relation(fields: [couponId], references: [id])
  items           OrderItem[]
  payment         Payment?
  shipment        Shipment?
  refunds         Refund[]
  reservations    StockReservation[]
  
  @@index([customerId])
  @@index([orderNumber])
  @@index([status])
  @@index([customerId, createdAt(sort: Desc)])
}

/// Order line items with product snapshot
model OrderItem {
  id              Int       @id @default(autoincrement())
  orderId         Int
  productId       Int
  productName     String
  productSku      String
  variantName     String?
  quantity        Int
  unitPrice       Decimal   @db.Decimal(10, 2)
  subtotal        Decimal   @db.Decimal(10, 2)
  createdAt       DateTime  @default(now())
  
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         Product   @relation(fields: [productId], references: [id])
  refundItems     RefundItem[]
  
  @@index([orderId])
}

/// Discount coupons
/// @route /coupons
/// @auth admin
model Coupon {
  id              Int       @id @default(autoincrement())
  code            String    @unique
  description     String?
  discountType    DiscountType
  discountValue   Decimal   @db.Decimal(10, 2)
  minPurchase     Decimal?  @db.Decimal(10, 2)
  maxDiscount     Decimal?  @db.Decimal(10, 2)
  usageLimit      Int?
  usageCount      Int       @default(0)
  validFrom       DateTime
  validUntil      DateTime?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  orders          Order[]
  
  @@index([code])
  @@index([isActive, validFrom, validUntil])
}

/// Payment transactions
/// @route /payments
/// @auth admin
model Payment {
  id              Int       @id @default(autoincrement())
  orderId         Int       @unique
  paymentMethod   PaymentMethod
  status          PaymentStatus @default(PENDING)
  amount          Decimal   @db.Decimal(10, 2)
  transactionId   String?
  gatewayResponse Json?
  paidAt          DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  order           Order     @relation(fields: [orderId], references: [id])
  
  @@index([status])
  @@index([transactionId])
}

/// Shipment tracking
/// @route /shipments
/// @auth admin
model Shipment {
  id              Int       @id @default(autoincrement())
  orderId         Int       @unique
  carrier         String
  trackingNumber  String?
  status          ShipmentStatus @default(PREPARING)
  shippedAt       DateTime?
  deliveredAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  order           Order     @relation(fields: [orderId], references: [id])
  
  @@index([trackingNumber])
}

/// Refund tracking
/// @route /refunds
/// @auth admin
model Refund {
  id              Int       @id @default(autoincrement())
  orderId         Int
  refundNumber    String    @unique
  reason          RefundReason
  amount          Decimal   @db.Decimal(10, 2)
  status          RefundStatus @default(PENDING)
  refundMethod    PaymentMethod
  notes           String?
  processedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  order           Order     @relation(fields: [orderId], references: [id])
  items           RefundItem[]
  
  @@index([orderId])
  @@index([refundNumber])
  @@index([status])
}

/// Refund line items
model RefundItem {
  id              Int       @id @default(autoincrement())
  refundId        Int
  orderItemId     Int
  quantity        Int
  amount          Decimal   @db.Decimal(10, 2)
  
  refund          Refund    @relation(fields: [refundId], references: [id], onDelete: Cascade)
  orderItem       OrderItem @relation(fields: [orderItemId], references: [id])
  
  @@index([refundId])
}

/// Product reviews with images
/// @route /reviews
/// @auth required
model Review {
  id              Int       @id @default(autoincrement())
  productId       Int
  customerId      Int
  rating          Int
  title           String?
  content         String
  isVerified      Boolean   @default(false)
  isApproved      Boolean   @default(false)
  helpfulCount    Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  customer        Customer  @relation(fields: [customerId], references: [id])
  images          ReviewImage[]
  
  @@unique([productId, customerId])
  @@index([productId])
  @@index([productId, isApproved, createdAt(sort: Desc)])
}

/// Review images
model ReviewImage {
  id              Int       @id @default(autoincrement())
  reviewId        Int
  imageUrl        String
  createdAt       DateTime  @default(now())
  
  review          Review    @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  
  @@index([reviewId])
}

/// Product tags
model ProductTag {
  productId       Int
  tagId           Int
  
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag             Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([productId, tagId])
}

/// Tags for products
/// @route /tags
/// @auth admin
model Tag {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  slug            String    @unique
  
  products        ProductTag[]
  
  @@index([slug])
}

/// Customer wishlist
model WishlistItem {
  id              Int       @id @default(autoincrement())
  customerId      Int
  productId       Int
  addedAt         DateTime  @default(now())
  
  customer        Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([customerId, productId])
  @@index([customerId])
}

/// Product availability alerts
model ProductAlert {
  id              Int       @id @default(autoincrement())
  customerId      Int
  productId       Int
  alertType       AlertType
  triggered       Boolean   @default(false)
  triggeredAt     DateTime?
  createdAt       DateTime  @default(now())
  
  customer        Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([customerId, productId, alertType])
  @@index([productId, alertType, triggered])
}

// Enums
enum AddressType {
  SHIPPING
  BILLING
}

enum ProductCondition {
  NEW
  REFURBISHED
  USED_LIKE_NEW
  USED_GOOD
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  STRIPE
  BANK_TRANSFER
  CASH_ON_DELIVERY
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
  CANCELLED
}

enum ShipmentStatus {
  PREPARING
  SHIPPED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
  RETURNED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

enum RefundReason {
  DEFECTIVE
  WRONG_ITEM
  NOT_AS_DESCRIBED
  CHANGED_MIND
  DUPLICATE_ORDER
  OTHER
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSING
  COMPLETED
}

enum StockChangeReason {
  SALE
  RETURN
  ADJUSTMENT
  RESTOCK
  DAMAGED
  LOST
}

enum AlertType {
  BACK_IN_STOCK
  PRICE_DROP
}

